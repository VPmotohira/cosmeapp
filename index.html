<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚Œãƒ­ã‚¸ãƒƒã‚¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Playfair+Display:wght@500;600&family=Caveat&display=swap" rel="stylesheet">
    <style>
        :root {
            --canvas-bg: #FAFAF9;
            --surface-bg: #FFFFFF;
            --line-color: #E5E7EB;
            --ink-primary: #111827;
            --ink-secondary: #6B7280;
            --brand-accent: #BFA77B;
            --brand-support: #93C5FD;
            --success-color: #22C55E;
            --warning-color: #F59E0B;
            --heading-font: 'Playfair Display', serif;
            --body-font: 'Noto Sans JP', sans-serif;
            --radius-card: 12px;
            --shadow-card: 0 6px 20px rgba(0,0,0,0.07);
        }
        body { font-family: var(--body-font); background-color: var(--canvas-bg); color: var(--ink-primary); margin: 0; padding: 20px 20px 100px 20px; }
        #app-container { max-width: 600px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        header h1 { font-family: var(--heading-font); font-weight: 500; color: var(--ink-primary); }
        header h1 .accent { color: var(--brand-accent); }
        .card { background-color: var(--surface-bg); border-radius: var(--radius-card); padding: 25px; margin-bottom: 25px; box-shadow: var(--shadow-card); border: 1px solid var(--line-color); }
        h2 { font-family: var(--heading-font); font-weight: 500; margin-top: 0; margin-bottom: 20px; font-size: 1.3em; border-bottom: 1px solid var(--line-color); padding-bottom: 15px; }
        nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 600px; margin: 0 auto; display: flex; justify-content: space-around; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); border-top: 1px solid var(--line-color); padding: 10px 0; z-index: 100; }
        nav button { flex: 1; border: none; background-color: transparent; cursor: pointer; font-size: 0.8em; font-weight: 500; color: var(--ink-secondary); transition: all 0.3s ease; padding: 8px 0; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        nav button.active { color: var(--brand-support); }
        nav button .nav-icon { transition: transform 0.3s ease; }
        nav button.active .nav-icon { transform: scale(1.1); }
        button { border-radius: var(--radius-card); cursor: pointer; font-size: 0.9em; font-weight: 500; transition: all 0.2s ease-out; padding: 10px 16px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-primary { background-color: var(--brand-support); color: white; border: none; }
        .btn-secondary { background-color: var(--surface-bg); color: var(--brand-support); border: 1px solid var(--brand-support); }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .condition-chips { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; padding: 20px; background-color: var(--surface-bg); border-radius: var(--radius-card); box-shadow: var(--shadow-card); }
        .chip-group { display: flex; align-items: center; gap: 8px; }
        .chip-group label { font-size: 0.9em; font-weight: 500; color: var(--ink-secondary); min-width: 40px; }
        .chips { display: flex; background-color: var(--line-color); border-radius: 20px; padding: 4px; }
        .chips button { font-size: 0.8em; padding: 6px 14px; border-radius: 20px; color: var(--ink-secondary); border: none; background-color: transparent; box-shadow: none; }
        .chips button.selected { background-color: var(--brand-support); color: white; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .task-item { display: flex; align-items: center; padding: 12px; margin-bottom: 12px; background-color: var(--surface-bg); border-radius: var(--radius-card); transition: all 0.3s ease; border: 1px solid var(--line-color); }
        .task-item.completed { opacity: 0.6; }
        .task-checkbox { appearance: none; width: 24px; height: 24px; border: 2px solid var(--line-color); border-radius: 50%; margin-right: 15px; cursor: pointer; transition: all 0.2s ease; position: relative; flex-shrink: 0; }
        .task-checkbox:checked { background-color: var(--success-color); border-color: var(--success-color); }
        .task-checkbox:checked::after { content: 'âœ“'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; }
        .reason-badge { font-size: 0.7em; padding: 3px 8px; border-radius: 10px; margin-top: 4px; display: inline-block; font-weight: 500; }
        .reason-badge.info { background-color: #DBEAFE; color: #1E40AF; }
        .reason-badge.warning { background-color: #FEF3C7; color: #92400E; }
        .line-chart-container { width: 100%; height: 180px; }
    </style>
</head>
<body>
    <div id="app-container">
        <header>
            <h1 id="header-title">ä»Šæ—¥ã®ãƒ¬ã‚·ãƒ”</h1>
            <p id="current-date"></p>
        </header>
        <main>
            <div id="main-screen" class="screen active"></div>
            <div id="schedule-screen" class="screen"></div>
            <div id="inventory-screen" class="screen"></div>
            <div id="diary-screen" class="screen"></div>
            <div id="account-screen" class="screen"></div>
        </main>
        <nav>
            <button data-screen="main" class="active"><span class="nav-icon">ğŸ </span>ãƒ›ãƒ¼ãƒ </button>
            <button data-screen="schedule"><span class="nav-icon">ğŸ—“ï¸</span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</button>
            <button data-screen="inventory"><span class="nav-icon">ğŸ§´</span>ã‚³ã‚¹ãƒ¡</button>
            <button data-screen="diary"><span class="nav-icon">ğŸ“–</span>ãƒ€ã‚¤ã‚¢ãƒªãƒ¼</button>
            <button data-screen="account"><span class="nav-icon">ğŸ‘¤</span>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</button>
        </nav>
        <div id="modal-container"></div>
    </div>

<script>
/**
 * ç¾è‚Œãƒ­ã‚¸ãƒƒã‚¯ â€“ ãƒ•ãƒ«çµ±åˆç‰ˆ
 * - ãƒ›ãƒ¼ãƒ ï¼š
 *   - AM/PMãã‚Œãã‚Œã€Œå…¨ã¦å®Œäº†ã€ã€Œã“ã®ãƒ¬ã‚·ãƒ”ã‚’ã‚·ã‚§ã‚¢ã€
 *   - æ˜¨æ—¥ã®ãƒ¬ã‚·ãƒ”ãƒ»éå»ãƒ¬ã‚·ãƒ”å¼•ç”¨
 *   - ãƒ¬ã‚·ãƒ”ä¿å­˜
 *   - AM/PMåˆ¥ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ 
 * - ã‚³ã‚¹ãƒ¡ä¸€è¦§ï¼š
 *   - ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰æ¤œç´¢ã—ã¦è¿½åŠ 
 *   - é–‹å§‹æ—¥å…¥åŠ›
 *   - ã€Œãªããªã‚Šãã†ã€ã€Œã‚‚ã†ä½¿ã‚ãªã„ã€ãƒ•ãƒ©ã‚°
 *   - ã‚«ã‚¹ã‚¿ãƒ è¿½åŠ ãƒ»å‰Šé™¤
 * - çŠ¶æ…‹ã¯localStorageã§ä¿æŒ
 */

document.addEventListener('DOMContentLoaded', () => {
  /* ===== ãƒ‡ãƒ¢ç”¨ãƒã‚¹ã‚¿ãƒ¼ ===== */
  const masterInventory = [
    { id:'item1', category:'ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°', name:'ã‚·ãƒ¥ã‚¦ ã‚¦ã‚¨ãƒ ãƒ©', image:'https://placehold.co/200x200/A67B5B/FFFFFF?text=S' },
    { id:'item2', category:'æ´—é¡”',         name:'B.A ã‚¦ã‚©ãƒƒã‚·ãƒ¥ N', image:'https://placehold.co/200x200/1A1A1A/FFFFFF?text=B.A' },
    { id:'item3', category:'é…µç´ æ´—é¡”',     name:'ã‚¹ã‚¤ã‚µã‚¤',         image:'https://placehold.co/200x200/63C3C3/FFFFFF?text=SU' },
    { id:'item4', category:'åŒ–ç²§æ°´',       name:'ã‚ªãƒ«ãƒ“ã‚¹ãƒ¦ãƒ¼',     image:'https://placehold.co/200x200/368CCB/FFFFFF?text=O' },
    { id:'item5', category:'ç¾å®¹æ¶²',       name:'ãƒ©ãƒ³ã‚³ãƒ  ã‚¸ã‚§ãƒ‹ãƒ•ã‚£ãƒƒã‚¯', image:'https://placehold.co/200x200/2D2D2D/FFFFFF?text=L' },
    { id:'item6', category:'ä¹³æ¶²',         name:'SK-II ã‚¹ã‚­ãƒ³ãƒ‘ãƒ¯ãƒ¼', image:'https://placehold.co/200x200/C9002B/FFFFFF?text=SK' },
    { id:'item7', category:'æ—¥ç„¼ã‘æ­¢ã‚',   name:'ã‚¢ãƒãƒƒã‚µ',         image:'https://placehold.co/200x200/F2BE22/FFFFFF?text=AN' },
  ];

  const CATEGORIES = ['ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°','æ´—é¡”','åŒ–ç²§æ°´','ç¾å®¹æ¶²','ä¹³æ¶²','æ—¥ç„¼ã‘æ­¢ã‚','é…µç´ æ´—é¡”','ãã®ä»–'];
  const catalog = [
    ...masterInventory.map(m => ({ id:m.id, name:m.name, category:m.category, image:m.image })),
    { id:'cat001', name:'ã‚¤ãƒ—ã‚µ ã‚¶ãƒ»ã‚¿ã‚¤ãƒ R ã‚¢ã‚¯ã‚¢', category:'åŒ–ç²§æ°´', image:'https://placehold.co/200x200/2F80ED/FFFFFF?text=IP' },
    { id:'cat002', name:'ã‚­ãƒ¼ãƒ«ã‚º ã‚¯ãƒªãƒ¼ãƒ  UFC', category:'ä¹³æ¶²', image:'https://placehold.co/200x200/111/FFFFFF?text=K' },
    { id:'cat003', name:'é­”å¥³å·¥å ´ ãƒ”ãƒ¥ã‚¢ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°ã‚ªã‚¤ãƒ«', category:'ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°', image:'https://placehold.co/200x200/EAB308/FFFFFF?text=MJ' },
    { id:'cat004', name:'CeraVe Foaming Cleanser', category:'æ´—é¡”', image:'https://placehold.co/200x200/16A34A/FFFFFF?text=CV' },
    { id:'cat005', name:'ãƒ“ã‚ªãƒ¬UV ã‚¢ã‚¯ã‚¢ãƒªãƒƒãƒ', category:'æ—¥ç„¼ã‘æ­¢ã‚', image:'https://placehold.co/200x200/3B82F6/FFFFFF?text=UV' },
    { id:'cat006', name:'The Ordinary Niacinamide 10%', category:'ç¾å®¹æ¶²', image:'https://placehold.co/200x200/64748B/FFFFFF?text=TO' },
  ];

  const DURATION_MIN = {
    'ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°':2, 'æ´—é¡”':1, 'åŒ–ç²§æ°´':1, 'ç¾å®¹æ¶²':1, 'ä¹³æ¶²':1, 'æ—¥ç„¼ã‘æ­¢ã‚':1, 'é…µç´ æ´—é¡”':2
  };

  /* ===== çŠ¶æ…‹ ===== */
  const LS_KEY = 'skincare.app.v1';
  let state = loadState() || initState();

  function initState(){
    const todayISO = isoDate(new Date());
    return {
      dailyConditions: { skin:'normal', makeup:'no', outing:'no' },
      products: masterInventory.map(p => ({ id:p.id, wontUse:false, lowStock:false })),
      savedRecipes: [],
      history: [],
      today: { date: todayISO, conditions:{ skin:'normal', makeup:'no', outing:'no' }, am:[], pm:[], overrides:{amRemove:[],pmRemove:[],amAdd:[],pmAdd:[]}, whyMap:{} }
    };
  }
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function loadState(){ try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null; } }

  /* ===== åˆæœŸåŒ– ===== */
  const dom = {
    headerTitle: document.getElementById('header-title'),
    dateElement : document.getElementById('current-date'),
    nav         : document.querySelector('nav'),
    main        : document.querySelector('main'),
  };
  initialize();
  function initialize(){
    displayDate();
    migrateProductsShape();
    rolloverIfNeeded();
    dom.nav.addEventListener('click', onNavClick);
    renderCurrentScreen();
  }

  /* ===== ç”»é¢é·ç§» ===== */
  function onNavClick(e){
    const btn = e.target.closest('button'); if(!btn) return;
    const screen = btn.dataset.screen;
    dom.main.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    dom.nav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    const activeScreen = document.getElementById(`${screen}-screen`);
    activeScreen.classList.add('active'); btn.classList.add('active');
    dom.headerTitle.innerHTML = ({
      main: `ä»Šæ—¥ã®<span class="accent">ãƒ¬ã‚·ãƒ”</span>`,
      schedule:'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«', inventory:'ã‚³ã‚¹ãƒ¡ä¸€è¦§', diary:'ãƒ€ã‚¤ã‚¢ãƒªãƒ¼', account:'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ'
    })[screen];
    ({
      main: renderMainScreen, schedule: renderScheduleScreen, inventory: renderInventoryScreen,
      diary: renderDiaryScreen, account: renderAccountScreen
    })[screen](activeScreen);
  }
  function renderCurrentScreen(){ document.querySelector('button[data-screen="main"]').click(); }

  /* ===== ãƒ›ãƒ¼ãƒ  ===== */
  function renderMainScreen(container){
    container.innerHTML = `
      <div class="condition-chips">
        <div class="chip-group"><label>è‚Œ:</label><div class="chips" data-group="skin"><button data-value="bad">è’ã‚Œ</button><button data-value="normal">æ™®é€š</button><button data-value="good">è‰¯ã„</button></div></div>
        <div class="chip-group"><label>ãƒ¡ã‚¤ã‚¯:</label><div class="chips" data-group="makeup"><button data-value="yes">ã‚ã‚Š</button><button data-value="no">ãªã—</button></div></div>
        <div class="chip-group"><label>å¤–å‡º:</label><div class="chips" data-group="outing"><button data-value="yes">ã‚ã‚Š</button><button data-value="no">ãªã—</button></div></div>
      </div>
      <div class="mb-3 flex gap-2">
        <button class="btn-secondary text-sm" id="apply-yesterday">æ˜¨æ—¥ã®ãƒ¬ã‚·ãƒ”ã‚’åæ˜ </button>
        <button class="btn-secondary text-sm" id="apply-past">éå»ã®ãƒ¬ã‚·ãƒ”ã‚’é¸æŠ</button>
        <button class="btn-secondary text-sm" id="save-recipe">ã“ã®ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜</button>
      </div>
      <div id="recalculating-feedback" class="text-center text-sm text-gray-500 mb-4 h-5"></div>
      <div id="manual-container"></div>
    `;
    // condition chips
    container.querySelectorAll('.chips').forEach(div => {
      div.querySelectorAll('button').forEach(b => b.classList.toggle('selected', b.dataset.value===state.dailyConditions[div.dataset.group]));
      div.addEventListener('click', (e) => {
        if(e.target.tagName!=='BUTTON') return;
        state.dailyConditions[div.dataset.group] = e.target.dataset.value;
        if (state.today) state.today.conditions = { ...state.dailyConditions };
        saveState(); showRecalc(()=>{ recalcTodayByRules(); renderManual(); });
        div.querySelectorAll('button').forEach(b=>b.classList.remove('selected')); e.target.classList.add('selected');
      });
    });

    // ãƒ¬ã‚·ãƒ”åæ˜ /ä¿å­˜
    container.querySelector('#apply-yesterday').addEventListener('click', ()=>applyYesterday());
    container.querySelector('#apply-past').addEventListener('click', ()=>applyPast());
    container.querySelector('#save-recipe').addEventListener('click', ()=>saveCurrentRecipe());

    if (!state.today || (!state.today.am.length && !state.today.pm.length)) { state.today = makeTodayFromRules(); saveState(); }
    renderManual();
  }

  function renderManual(){
    const wrap = document.getElementById('manual-container'); if(!wrap || !state.today) return;
    const { amMinutes, pmMinutes } = calcDurations(state.today);
    wrap.innerHTML =
      createSection('â˜€ï¸ æœã®ãƒ¬ã‚·ãƒ”', state.today.am, amMinutes, 'AM') +
      createSection('ğŸŒ™ å¤œã®ãƒ¬ã‚·ãƒ”', state.today.pm, pmMinutes, 'PM');

    wrap.querySelectorAll('[data-action="complete-all"]').forEach(b => b.addEventListener('click', () => onCompleteAll(b.dataset.time)));
    wrap.querySelectorAll('[data-action="share-section"]').forEach(b => b.addEventListener('click', () => onShareSection(b.dataset.time)));
    wrap.querySelectorAll('[data-action="add-item"]').forEach(b => b.addEventListener('click', () => onAddItem(b.dataset.time)));
  }

  function createSection(title, steps, minutes, tod){
    const list = steps.filter(s=>!s.hidden).map(s => {
      const p = masterInventory.find(i=>i.id===s.productId);
      return `
        <li class="task-item">
          <input type="checkbox" class="task-checkbox"/>
          <img src="${p?.image||'https://placehold.co/80'}" class="w-12 h-12 rounded-lg">
          <div class="ml-3">
            <p class="font-bold text-sm">${p?.name||s.stepType}</p>
            <p class="text-xs text-gray-500">${p?.category||s.stepType}</p>
          </div>
        </li>`;
    }).join('') || `<li class="text-sm text-gray-400">ã‚¹ãƒ†ãƒƒãƒ—ãªã—</li>`;

    return `
      <div class="card p-5 mb-4">
        <div class="flex items-center justify-between">
          <h3 class="font-bold text-lg">${title}</h3>
          <span class="text-xs text-gray-500">ç›®å®‰ ${minutes}åˆ†</span>
        </div>
        <ul class="mt-3 space-y-2">${list}</ul>
        <div class="mt-3 grid grid-cols-3 gap-2">
          <button class="btn-primary text-sm" data-action="complete-all" data-time="${tod}">å…¨ã¦å®Œäº†</button>
          <button class="btn-secondary text-sm" data-action="share-section" data-time="${tod}">ã“ã®ãƒ¬ã‚·ãƒ”ã‚’ã‚·ã‚§ã‚¢</button>
          <button class="btn-secondary text-sm" data-action="add-item" data-time="${tod}">ï¼‹ ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ </button>
        </div>
      </div>`;
  }

  /* ===== ãƒ¬ã‚·ãƒ”æ“ä½œ ===== */
  function applyYesterday(){
    if (state.history.length < 1) { alert('æ˜¨æ—¥ã®ãƒ¬ã‚·ãƒ”ã¯ã‚ã‚Šã¾ã›ã‚“'); return; }
    const y = state.history[0];
    state.today.am = JSON.parse(JSON.stringify(y.am));
    state.today.pm = JSON.parse(JSON.stringify(y.pm));
    saveState(); renderManual();
  }
  function applyPast(){
    if (state.history.length < 1) { alert('éå»ã®ãƒ¬ã‚·ãƒ”ã¯ã‚ã‚Šã¾ã›ã‚“'); return; }
    const choice = prompt('éå»ã®ãƒ¬ã‚·ãƒ”ç•ªå·ã‚’å…¥åŠ› (1ã€œ'+state.history.length+')');
    const idx = parseInt(choice,10)-1;
    if (idx>=0 && idx<state.history.length){
      state.today.am = JSON.parse(JSON.stringify(state.history[idx].am));
      state.today.pm = JSON.parse(JSON.stringify(state.history[idx].pm));
      saveState(); renderManual();
    }
  }
  function saveCurrentRecipe(){
    const name = prompt('ã“ã®ãƒ¬ã‚·ãƒ”ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    if (!name) return;
    state.savedRecipes.push({ id: uuid(), name, am:JSON.parse(JSON.stringify(state.today.am)), pm:JSON.parse(JSON.stringify(state.today.pm)) });
    saveState(); alert('ä¿å­˜ã—ã¾ã—ãŸ');
  }
  function onCompleteAll(time){
    const idx = time === 'AM' ? 1 : 2;
    const list = document.querySelectorAll(`#manual-container .card:nth-of-type(${idx}) .task-checkbox`);
    list.forEach(cb => cb.checked = true);
  }
  function onShareSection(time){
    const steps = (time === 'AM' ? state.today.am : state.today.pm).filter(s => !s.hidden);
    const lines = steps.map(s => {
      const p = masterInventory.find(m=>m.id===s.productId);
      const label = p ? `${p.category}ï¼š${p.name}` : s.stepType;
      return `ãƒ»${label}`;
    }).join('\n');
    const text = `${time}ã®ãƒ¬ã‚·ãƒ”\n${lines || 'ï¼ˆã‚¹ãƒ†ãƒƒãƒ—ãªã—ï¼‰'}`;
    if (navigator.share) { navigator.share({ text }).catch(()=>{}); }
    else { navigator.clipboard.writeText(text).then(()=>alert('ãƒ¬ã‚·ãƒ”ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')); }
  }
  function onAddItem(time){
    const name = prompt('è¿½åŠ ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ å');
    if (!name) return;
    const category = prompt('ã‚«ãƒ†ã‚´ãƒªï¼ˆä¾‹ï¼šåŒ–ç²§æ°´ï¼‰');
    const id = uuid();
    masterInventory.push({ id, name, category, image:'https://placehold.co/200x200/777/FFFFFF?text=+' });
    state.products.push({ id, wontUse:false, lowStock:false });
    if (time==='AM') state.today.am.push(step(category,id,'AM'));
    else state.today.pm.push(step(category,id,'PM'));
    saveState(); renderManual();
  }

  /* ===== ãƒ«ãƒ¼ãƒ«é©ç”¨ ===== */
  function makeTodayFromRules(){
    const date = isoDate(new Date());
    const baseAM = [ step('æ´—é¡”','item2','AM'), step('åŒ–ç²§æ°´','item4','AM'), step('ä¹³æ¶²','item6','AM') ];
    const basePM = [ step('æ´—é¡”','item2','PM'), step('åŒ–ç²§æ°´','item4','PM'), step('ä¹³æ¶²','item6','PM') ];
    const today = { date, conditions:{...state.dailyConditions}, am:baseAM, pm:basePM, overrides:{amRemove:[],pmRemove:[],amAdd:[],pmAdd:[]}, whyMap:{} };
    applyRulesInPlace(today); return today;
  }
  function recalcTodayByRules(){ if(!state.today) return; applyRulesInPlace(state.today); saveState(); }
  function applyRulesInPlace(day){
    [...day.am, ...day.pm].forEach(s => { s.hidden = false; });
    const cond = day.conditions;
    if (cond.outing==='yes') {
      const hasSPF = day.am.some(s => !s.hidden && masterInventory.find(m=>m.id===s.productId)?.category==='æ—¥ç„¼ã‘æ­¢ã‚');
      if (!hasSPF) {
        const ownedSPF = state.products.filter(p=>!p.wontUse).map(x=>masterInventory.find(m=>m.id===x.id)).find(m=>m?.category==='æ—¥ç„¼ã‘æ­¢ã‚');
        if (ownedSPF) day.am.push(step('æ—¥ç„¼ã‘æ­¢ã‚', ownedSPF.id, 'AM'));
      }
    }
    if (cond.makeup==='yes') {
      const hasClr = day.pm.some(s => !s.hidden && masterInventory.find(m=>m.id===s.productId)?.category==='ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°');
      if (!hasClr) {
        const ownedClr = state.products.filter(p=>!p.wontUse).map(x=>masterInventory.find(m=>m.id===x.id)).find(m=>m?.category==='ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°');
        if (ownedClr) day.pm.unshift(step('ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°', ownedClr.id, 'PM'));
      }
    }
  }

  /* ===== ã‚³ã‚¹ãƒ¡ä¸€è¦§ ===== */
  function renderInventoryScreen(container) {
    container.innerHTML = `
      <div class="card">
        <h2 class="flex items-center justify-between">
          <span>ãƒã‚¤ã‚³ã‚¹ãƒ¡</span>
          <div class="flex gap-2">
            <input id="inv-search" type="search" placeholder="æ¤œç´¢ï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰/å•†å“å/ã‚«ãƒ†ã‚´ãƒªï¼‰" class="border rounded px-3 py-1 text-sm w-44 sm:w-72" />
            <button id="inv-add" class="btn-primary text-sm">ï¼‹ è¿½åŠ </button>
          </div>
        </h2>
        <div id="inv-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-3"></div>
      </div>

      <div id="inv-modal" class="hidden fixed inset-0 bg-black/30 flex items-end sm:items-center sm:justify-center z-50">
        <div class="bg-white w-full sm:w-[720px] rounded-t-2xl sm:rounded-2xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">ã‚³ã‚¹ãƒ¡ã‚’è¿½åŠ </h3>
            <button id="inv-modal-close" class="text-gray-500 text-lg">âœ•</button>
          </div>
          <div class="grid gap-3">
            <div id="cat-tabs" class="flex flex-wrap gap-2"></div>
            <input id="cat-q" class="border rounded px-3 py-2 text-sm" placeholder="å•†å“åãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰åã§çµã‚Šè¾¼ã¿ï¼ˆä»»æ„ï¼‰" />
            <div id="cat-list" class="max-h-[420px] overflow-auto grid sm:grid-cols-2 gap-2"></div>
            <div class="text-xs text-gray-500">è¦‹ã¤ã‹ã‚‰ãªã„ï¼Ÿ <button id="cat-add-manual" class="underline">æ‰‹å…¥åŠ›ã§è¿½åŠ </button></div>
          </div>
        </div>
      </div>
    `;

    const grid   = container.querySelector('#inv-grid');
    const search = container.querySelector('#inv-search');
    const addBtn = container.querySelector('#inv-add');

    const render = () => {
      const q = (search.value || '').trim().toLowerCase();
      const ownedIds = new Set(state.products.map(p => p.id));
      const items = masterInventory.filter(m => ownedIds.has(m.id));
      const filtered = !q ? items : items.filter(m => [m.name,m.category].join(' ').toLowerCase().includes(q));

      grid.innerHTML = filtered.map(item => inventoryCardHTML(item)).join('')
        || `<p class="text-sm text-gray-500">ç™»éŒ²ã‚³ã‚¹ãƒ¡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œï¼‹ è¿½åŠ ã€ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>`;

      bindInventoryHandlers(grid);
    };

    search.addEventListener('input', render);

    const modal = container.querySelector('#inv-modal');
    const close = container.querySelector('#inv-modal-close');
    const qEl   = container.querySelector('#cat-q');
    const list  = container.querySelector('#cat-list');
    const tabs  = container.querySelector('#cat-tabs');
    const addManual = container.querySelector('#cat-add-manual');
    let activeCat = CATEGORIES[0];

    function openModal(){
      modal.classList.remove('hidden');
      buildTabs(); renderCatalog(); setTimeout(()=>qEl.focus(),0);
    }
    function closeModal(){ modal.classList.add('hidden'); }

    addBtn.addEventListener('click', openModal);
    close.addEventListener('click', closeModal);
    qEl.addEventListener('input', renderCatalog);

    addManual.addEventListener('click', () => {
      const name = prompt('å•†å“å'); if(!name) return;
      const category = prompt(`ã‚«ãƒ†ã‚´ãƒªï¼ˆ${CATEGORIES.join(' / ')} ãªã©ï¼‰`); if(!category) return;
      const id = uuid();
      masterInventory.push({ id, name, category, image:'https://placehold.co/200x200/777/FFFFFF?text=NEW', custom:true });
      state.products.push({ id, wontUse:false, lowStock:false });
      saveState(); render(); closeModal();
    });

    function buildTabs(){
      tabs.innerHTML = CATEGORIES.map(cat => `
        <button data-tab="${cat}" class="px-3 py-1 rounded-full border text-sm ${cat===activeCat?'bg-black text-white':'bg-white'}">${cat}</button>
      `).join('');
      tabs.querySelectorAll('button[data-tab]').forEach(b=>{
        b.addEventListener('click', () => { activeCat=b.dataset.tab; buildTabs(); renderCatalog(); });
      });
    }

    function renderCatalog(){
      const qs = (qEl.value||'').trim().toLowerCase();
      const pool = catalog.filter(c => (activeCat==='ãã®ä»–' ? !CATEGORIES.includes(c.category) || c.category===activeCat : c.category===activeCat));
      const results = pool.filter(c => !qs || [c.name].join(' ').toLowerCase().includes(qs)).slice(0,80);
      list.innerHTML = results.map(c => {
        const owned = state.products.some(p => p.id === c.id);
        return `
          <div class="flex gap-3 p-2 border rounded-lg">
            <img src="${c.image}" class="w-14 h-14 rounded-lg object-cover" />
            <div class="flex-1 min-w-0">
              <div class="text-sm font-medium truncate">${c.name}</div>
              <div class="text-xs text-gray-500">${c.category}</div>
            </div>
            <button class="text-xs ${owned?'btn-secondary opacity-60':'btn-primary'} h-8 self-center" data-add="${c.id}" ${owned?'disabled':''}>${owned?'ç™»éŒ²æ¸ˆã¿':'è¿½åŠ '}</button>
          </div>`;
      }).join('') || `<p class="text-sm text-gray-500">è©²å½“ãªã—</p>`;

      list.querySelectorAll('button[data-add]').forEach(b => {
        b.addEventListener('click', () => {
          const id = b.dataset.add;
          let item = masterInventory.find(m => m.id === id);
          if (!item) {
            const c = catalog.find(x => x.id === id); if(!c) return;
            item = { id:c.id, name:c.name, category:c.category, image:c.image, custom:true };
            masterInventory.push(item);
          }
          if (!state.products.some(p => p.id === id)) state.products.push({ id, wontUse:false, lowStock:false });
          saveState(); b.textContent='ç™»éŒ²æ¸ˆã¿'; b.disabled=true; b.classList.add('opacity-60'); render();
        });
      });
    }

    render();
  }

  function inventoryCardHTML(item){
    const prodState = state.products.find(p => p.id === item.id) || {};
    const start = prodState.startDate || '';
    const wont  = !!prodState.wontUse;
    const low   = !!prodState.lowStock;
    const grad  = avatarGradient(item.category);
    const initials = brandInitials(item.name);
    return `
      <div class="rounded-2xl p-3 border border-gray-100 shadow-sm bg-white">
        <div class="flex gap-3">
          <div class="w-14 h-14 rounded-xl grid place-items-center text-white font-semibold shadow" style="background:${grad}">${initials}</div>
          <div class="flex-1 min-w-0">
            <p class="font-bold text-sm leading-tight truncate" title="${item.name}">${item.name}</p>
            <p class="text-[11px] text-gray-500">${item.category}</p>
          </div>
          <div class="flex gap-1 flex-wrap justify-end">
            ${wont?`<span class="px-2 py-0.5 text-[10px] rounded-full bg-amber-100 text-amber-700">ğŸš«ã‚‚ã†ä½¿ã‚ãªã„</span>`:''}
            ${low?`<span class="px-2 py-0.5 text-[10px] rounded-full bg-sky-100 text-sky-700">ğŸ”¥ãªããªã‚Šãã†</span>`:''}
          </div>
        </div>
        <div class="mt-3 grid grid-cols-2 gap-2 text-xs">
          <label class="col-span-2">
            <span class="text-gray-500">é–‹å§‹æ—¥ï¼ˆä»»æ„ï¼‰</span>
            <input type="date" value="${start}" data-pid="${item.id}" class="mt-1 w-full border rounded px-2 py-1 text-sm"/>
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" data-low="${item.id}" ${low?'checked':''}/> ãªããªã‚Šãã†
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" data-wont="${item.id}" ${wont?'checked':''}/> ã‚‚ã†ä½¿ã‚ãªã„
          </label>
        </div>
        ${item.custom?`<div class="mt-2 text-right"><button class="px-2 py-1 border rounded text-xs" data-del="${item.id}">å‰Šé™¤</button></div>`:''}
      </div>
    `;
  }

  function bindInventoryHandlers(grid){
    grid.querySelectorAll('input[type="date"]').forEach(inp=>{
      inp.addEventListener('change', ()=>{
        const pid = inp.dataset.pid;
        const rec = state.products.find(p => p.id === pid);
        if (rec) rec.startDate = inp.value || undefined;
        saveState();
      });
    });
    grid.querySelectorAll('input[data-wont]').forEach(chk=>{
      chk.addEventListener('change', ()=>{
        const rec = state.products.find(p => p.id === chk.dataset.wont);
        if (rec) rec.wontUse = chk.checked; saveState();
      });
    });
    grid.querySelectorAll('input[data-low]').forEach(chk=>{
      chk.addEventListener('change', ()=>{
        const rec = state.products.find(p => p.id === chk.dataset.low);
        if (rec) rec.lowStock = chk.checked; saveState();
      });
    });
    grid.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const pid = btn.dataset.del;
        const item = masterInventory.find(m=>m.id===pid);
        if (!item?.custom) return;
        if (!confirm(`ã€Œ${item.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        state.products = state.products.filter(p=>p.id!==pid);
        const idx = masterInventory.findIndex(m=>m.id===pid);
        if (idx>=0) masterInventory.splice(idx,1);
        saveState();
        btn.closest('.rounded-2xl')?.remove();
      });
    });
  }

  /* ===== ä»–ç”»é¢ ===== */
  function renderScheduleScreen(container){ container.innerHTML = `<div class="card"><h2>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2><p class="text-sm text-gray-500">é–‹ç™ºä¸­ã§ã™</p></div>`; }
  function renderDiaryScreen(container){ container.innerHTML = `<div class="card"><h2>ãƒ€ã‚¤ã‚¢ãƒªãƒ¼</h2><p class="text-sm text-gray-500">é–‹ç™ºä¸­ã§ã™</p></div>`; }
  function renderAccountScreen(container){ container.innerHTML = `<div class="card"><h2>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h2><p class="text-sm text-gray-500">ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ä¸è¦ã§åˆ©ç”¨ã§ãã¾ã™</p></div>`; }

  /* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
  function step(stepType, productId, tod){ const prod = masterInventory.find(i=>i.id===productId); return { id:uuid(), timeOfDay:tod, order:0, stepType, productId, durationMin: DURATION_MIN[prod?.category||stepType]||1, hidden:false }; }
  function calcDurations(day){ const sum = (arr)=>arr.filter(s=>!s.hidden).reduce((a,s)=>a+(s.durationMin||1),0); return { amMinutes:sum(day.am), pmMinutes:sum(day.pm) }; }
  function uuid(){ return Math.random().toString(36).slice(2,10); }
  function showRecalc(cb){ const el=document.getElementById('recalculating-feedback'); if(!el){cb();return;} el.textContent='ãƒ¬ã‚·ãƒ”ã‚’å†è¨ˆç®—ä¸­...'; setTimeout(()=>{ el.textContent=''; cb(); },160); }
  function isoDate(d){ return d.toISOString().slice(0,10); }
  function displayDate(){ const t=new Date(); document.getElementById('current-date').textContent = `${t.getFullYear()}å¹´${t.getMonth()+1}æœˆ${t.getDate()}æ—¥`; }
  function rolloverIfNeeded(){
    const todayISO = isoDate(new Date());
    if (!state.today || state.today.date === todayISO) return;
    state.history.unshift({ id: uuid(), createdAt: state.today.date + 'T00:00:00Z', am: JSON.parse(JSON.stringify(state.today.am)), pm: JSON.parse(JSON.stringify(state.today.pm)) });
    state.today = makeTodayFromRules(); saveState();
  }
  function migrateProductsShape(){
    if (!Array.isArray(state.products)) return;
    state.products.forEach(p => {
      if (typeof p.wontUse === 'undefined') p.wontUse = false;
      if (typeof p.lowStock === 'undefined') p.lowStock = false;
    });
    saveState();
  }
  function brandInitials(name){
    const chunks = (name||'').replace(/\s+/g,' ').trim().split(' ');
    if (chunks.length===1) return chunks[0].slice(0,2).toUpperCase();
    return (chunks[0][0] + chunks[1][0]).toUpperCase();
  }
  function avatarGradient(category){
    const map = {
      'ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°':['#8B6B61','#C7AE97'],
      'æ´—é¡”':['#111827','#6B7280'],
      'é…µç´ æ´—é¡”':['#36CFC9','#9AE6E6'],
      'åŒ–ç²§æ°´':['#368CCB','#93C5FD'],
      'ç¾å®¹æ¶²':['#2D2D2D','#6B7280'],
      'ä¹³æ¶²':['#C9002B','#F59E9E'],
      'æ—¥ç„¼ã‘æ­¢ã‚':['#F59E0B','#FDE68A']
    };
    const g = map[category] || ['#888','#BBB'];
    return `linear-gradient(135deg, ${g[0]}, ${g[1]})`;
  }
});
</script>


</body>
</html>








