<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁæéËÇå„É≠„Ç∏„ÉÉ„ÇØ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Playfair+Display:wght@500;600&family=Caveat&display=swap" rel="stylesheet">
    <style>
        :root {
            --canvas-bg: #FAFAF9;
            --surface-bg: #FFFFFF;
            --line-color: #E5E7EB;
            --ink-primary: #111827;
            --ink-secondary: #6B7280;
            --brand-accent: #BFA77B;
            --brand-support: #93C5FD;
            --success-color: #22C55E;
            --warning-color: #F59E0B;
            --heading-font: 'Playfair Display', serif;
            --body-font: 'Noto Sans JP', sans-serif;
            --radius-card: 12px;
            --shadow-card: 0 6px 20px rgba(0,0,0,0.07);
        }
        body { font-family: var(--body-font); background-color: var(--canvas-bg); color: var(--ink-primary); margin: 0; padding: 20px 20px 100px 20px; }
        #app-container { max-width: 600px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        header h1 { font-family: var(--heading-font); font-weight: 500; color: var(--ink-primary); }
        header h1 .accent { color: var(--brand-accent); }
        .card { background-color: var(--surface-bg); border-radius: var(--radius-card); padding: 25px; margin-bottom: 25px; box-shadow: var(--shadow-card); border: 1px solid var(--line-color); }
        h2 { font-family: var(--heading-font); font-weight: 500; margin-top: 0; margin-bottom: 20px; font-size: 1.3em; border-bottom: 1px solid var(--line-color); padding-bottom: 15px; }
        nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 600px; margin: 0 auto; display: flex; justify-content: space-around; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); border-top: 1px solid var(--line-color); padding: 10px 0; z-index: 100; }
        nav button { flex: 1; border: none; background-color: transparent; cursor: pointer; font-size: 0.8em; font-weight: 500; color: var(--ink-secondary); transition: all 0.3s ease; padding: 8px 0; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        nav button.active { color: var(--brand-support); }
        nav button .nav-icon { transition: transform 0.3s ease; }
        nav button.active .nav-icon { transform: scale(1.1); }
        button { border-radius: var(--radius-card); cursor: pointer; font-size: 0.9em; font-weight: 500; transition: all 0.2s ease-out; padding: 10px 16px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-primary { background-color: var(--brand-support); color: white; border: none; }
        .btn-secondary { background-color: var(--surface-bg); color: var(--brand-support); border: 1px solid var(--brand-support); }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .condition-chips { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; padding: 20px; background-color: var(--surface-bg); border-radius: var(--radius-card); box-shadow: var(--shadow-card); }
        .chip-group { display: flex; align-items: center; gap: 8px; }
        .chip-group label { font-size: 0.9em; font-weight: 500; color: var(--ink-secondary); min-width: 40px; }
        .chips { display: flex; background-color: var(--line-color); border-radius: 20px; padding: 4px; }
        .chips button { font-size: 0.8em; padding: 6px 14px; border-radius: 20px; color: var(--ink-secondary); border: none; background-color: transparent; box-shadow: none; }
        .chips button.selected { background-color: var(--brand-support); color: white; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .task-item { display: flex; align-items: center; padding: 12px; margin-bottom: 12px; background-color: var(--surface-bg); border-radius: var(--radius-card); transition: all 0.3s ease; border: 1px solid var(--line-color); }
        .task-item.completed { opacity: 0.6; }
        .task-checkbox { appearance: none; width: 24px; height: 24px; border: 2px solid var(--line-color); border-radius: 50%; margin-right: 15px; cursor: pointer; transition: all 0.2s ease; position: relative; flex-shrink: 0; }
        .task-checkbox:checked { background-color: var(--success-color); border-color: var(--success-color); }
        .task-checkbox:checked::after { content: '‚úì'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; }
        .reason-badge { font-size: 0.7em; padding: 3px 8px; border-radius: 10px; margin-top: 4px; display: inline-block; font-weight: 500; }
        .reason-badge.info { background-color: #DBEAFE; color: #1E40AF; }
        .reason-badge.warning { background-color: #FEF3C7; color: #92400E; }
        .line-chart-container { width: 100%; height: 180px; }
    </style>
</head>
<body>
    <div id="app-container">
        <header>
            <h1 id="header-title">‰ªäÊó•„ÅÆ„É¨„Ç∑„Éî</h1>
            <p id="current-date"></p>
        </header>
        <main>
            <div id="main-screen" class="screen active"></div>
            <div id="schedule-screen" class="screen"></div>
            <div id="inventory-screen" class="screen"></div>
            <div id="diary-screen" class="screen"></div>
            <div id="account-screen" class="screen"></div>
        </main>
        <nav>
            <button data-screen="main" class="active"><span class="nav-icon">üè†</span>„Éõ„Éº„É†</button>
            <button data-screen="schedule"><span class="nav-icon">üóìÔ∏è</span>„Çπ„Ç±„Ç∏„É•„Éº„É´</button>
            <button data-screen="inventory"><span class="nav-icon">üß¥</span>„Ç≥„Çπ„É°</button>
            <button data-screen="diary"><span class="nav-icon">üìñ</span>„ÉÄ„Ç§„Ç¢„É™„Éº</button>
            <button data-screen="account"><span class="nav-icon">üë§</span>„Ç¢„Ç´„Ç¶„É≥„Éà</button>
        </nav>
        <div id="modal-container"></div>
    </div>

<script>
/**
 * ÁæéËÇå„É≠„Ç∏„ÉÉ„ÇØ ‚Äì Âçò‰∏ÄHTMLÁâàÔºà„Ç≥„Çπ„É°‰∏ÄË¶ß ÂÆåÂÖ®ÂØæÂøúÔºâ
 * Âê´„Åæ„Çå„ÇãÊ©üËÉΩÔºö
 * - „Éõ„Éº„É†ÔºöAM/PM„Çª„ÇØ„Ç∑„Éß„É≥„Åî„Å®„ÅÆ„Äå‚Ä¶„É°„Éã„É•„Éº„Äç„Åã„Çâ„É¨„Ç∑„ÉîÂèçÊò†/‰øùÂ≠ò„ÄÅÂÖ®„Å¶ÂÆå‰∫Ü„ÄÅ„Ç∑„Çß„Ç¢
 * - „É´„Éº„É´ÔºöÂ§ñÂá∫‚ÜíÊó•ÁÑº„ÅëÊ≠¢„ÇÅ„ÄÅ„É°„Ç§„ÇØ‚Üí„ÇØ„É¨„É≥„Ç∏„É≥„Ç∞„ÄÅËÇåËçí„Çå‚ÜíÈÖµÁ¥†/ÈÖ∏/„É¨„ÉÅ„Éé„Ç§„ÉâÈö†„Åó
 * - ÊâÄË¶ÅÊôÇÈñìË°®Á§∫„ÄÅwhyË°®Á§∫„ÄÅÈñãÂßã„Åã„ÇâÊó•Êï∞„Éê„ÉÉ„Ç∏„ÄÅ‰∏çË∂≥„Ç´„ÉÜ„Ç¥„É™ÊèêÊ°à
 * - Â±•Ê≠¥/‰øùÂ≠ò/localStorage Ê∞∏Á∂öÂåñ„ÄÅÊó•‰ªò„É≠„Éº„É´„Ç™„Éº„Éê„Éº
 * - „Ç≥„Çπ„É°‰∏ÄË¶ßÔºöÊ§úÁ¥¢„ÄÅÊâãÂÖ•Âäõ„ÅßËøΩÂä†„ÄÅÈñãÂßãÊó•„ÄÅÊâÄÊúâ„Éà„Ç∞„É´„ÄÅ**„ÇÇ„ÅÜ‰Ωø„Çè„Å™„ÅÑ**„Éà„Ç∞„É´„ÄÅÊâãÂÖ•ÂäõÂìÅ„ÅÆÂâäÈô§
 * - „Äå„ÇÇ„ÅÜ‰Ωø„Çè„Å™„ÅÑ„Äç„ÅØËá™ÂãïËøΩÂä†„ÉªÂÄôË£ú„Éª‰∏çË∂≥Âà§ÂÆö„Åã„ÇâÈô§Â§ñ
 */

document.addEventListener('DOMContentLoaded', () => {
  /* ===== „Éû„Çπ„ÇøÔºà„Éá„É¢Ôºâ ===== */
  const masterInventory = [
    { id:'item1', category:'„ÇØ„É¨„É≥„Ç∏„É≥„Ç∞', name:'„Ç∑„É•„Ç¶ „Ç¶„Ç®„É†„É©', image:'https://placehold.co/100x100/A67B5B/FFFFFF?text=S',  tags:['makeup'] },
    { id:'item2', category:'Ê¥óÈ°î',         name:'B.A „Ç¶„Ç©„ÉÉ„Ç∑„É• N', image:'https://placehold.co/100x100/1A1A1A/FFFFFF?text=B.A' },
    { id:'item3', category:'ÈÖµÁ¥†Ê¥óÈ°î',     name:'„Çπ„Ç§„Çµ„Ç§',         image:'https://placehold.co/100x100/63C3C3/FFFFFF?text=SU', schedule:{type:'weekly',days:[2,5]}, tags:['enzyme'], reason:{type:'warning', text:'‚ö†Ô∏è ËÇåËçí„ÇåÊôÇ„ÅØOFF'} },
    { id:'item4', category:'ÂåñÁ≤ßÊ∞¥',       name:'„Ç™„É´„Éì„Çπ„É¶„Éº',     image:'https://placehold.co/100x100/368CCB/FFFFFF?text=O' },
    { id:'item5', category:'ÁæéÂÆπÊ∂≤',       name:'„É©„É≥„Ç≥„É† „Ç∏„Çß„Éã„Éï„Ç£„ÉÉ„ÇØ', image:'https://placehold.co/100x100/2D2D2D/FFFFFF?text=L', reason:{type:'info', text:'üõ°Ô∏è ËÇåËçí„Çå„Ç±„Ç¢'} },
    { id:'item6', category:'‰π≥Ê∂≤',         name:'SK-II „Çπ„Ç≠„É≥„Éë„ÉØ„Éº', image:'https://placehold.co/100x100/C9002B/FFFFFF?text=SK' },
    { id:'item7', category:'Êó•ÁÑº„ÅëÊ≠¢„ÇÅ',   name:'„Ç¢„Éç„ÉÉ„Çµ',         image:'https://placehold.co/100x100/F2BE22/FFFFFF?text=AN', tags:['spf'], reason:{type:'info', text:'‚òÄÔ∏è Â§ñÂá∫„ÅÇ„Çä„ÅÆ„Åü„ÇÅ'} },
  ];

  /* ===== ÊâÄË¶ÅÊôÇÈñì(ÂàÜ) ===== */
  const DURATION_MIN = {
    '„ÇØ„É¨„É≥„Ç∏„É≥„Ç∞':2, 'Ê¥óÈ°î':1, 'ÂåñÁ≤ßÊ∞¥':1, 'ÁæéÂÆπÊ∂≤':1, '‰π≥Ê∂≤':1, 'Êó•ÁÑº„ÅëÊ≠¢„ÇÅ':1, 'ÈÖµÁ¥†Ê¥óÈ°î':2
  };

  /* ===== Áä∂ÊÖã ===== */
  const LS_KEY = 'skincare.app.v1';
  /**
   * state = {
   *   dailyConditions: { skin:'bad'|'normal'|'good', makeup:'yes'|'no', outing:'yes'|'no' },
   *   products: [{ id, startDate?, wontUse? }],
   *   savedRecipes: Recipe[], history: Recipe[], today?: DayInstance
   * }
   */
  let state = loadState() || initState();

  function initState(){
    const todayISO = isoDate(new Date());
    return {
      dailyConditions: { skin:'normal', makeup:'no', outing:'no' },
      products: masterInventory.map(p => ({ id:p.id, wontUse:false })), // ÊâÄÊúâ:ÂàùÊúüON„ÄÅÈñãÂßãÊó•„Å™„Åó
      savedRecipes: [],
      history: [],
      today: {
        date: todayISO,
        conditions: { skin:'normal', makeup:'no', outing:'no' },
        am: [], pm: [],
        overrides:{ amRemove:[], pmRemove:[], amAdd:[], pmAdd:[] },
        whyMap:{}
      }
    };
  }
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function loadState(){ try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null; } }

  /* ===== DOM ===== */
  const dom = {
    headerTitle: document.getElementById('header-title'),
    dateElement : document.getElementById('current-date'),
    nav         : document.querySelector('nav'),
    main        : document.querySelector('main'),
    modalContainer: document.getElementById('modal-container'),
  };

  /* ===== ÂàùÊúüÂåñ ===== */
  initialize();

  function initialize(){
    displayDate();
    rolloverIfNeeded();
    migrateProductsShape(); // wontUse „ÇíÊó¢Â≠ò„Éá„Éº„Çø„Å´‰ªò‰∏é
    dom.nav.addEventListener('click', onNavClick);
    renderCurrentScreen();
  }

  /* ===== ÁîªÈù¢ÈÅ∑Áßª ===== */
  function onNavClick(e){
    const btn = e.target.closest('button'); if(!btn) return;
    const screen = btn.dataset.screen;
    dom.main.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    dom.nav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    const activeScreen = document.getElementById(`${screen}-screen`);
    activeScreen.classList.add('active'); btn.classList.add('active');
    dom.headerTitle.innerHTML = ({
      main: `‰ªäÊó•„ÅÆ<span class="accent">„É¨„Ç∑„Éî</span>`,
      schedule:'„Çπ„Ç±„Ç∏„É•„Éº„É´', inventory:'„Ç≥„Çπ„É°‰∏ÄË¶ß', diary:'„ÉÄ„Ç§„Ç¢„É™„Éº', account:'„Ç¢„Ç´„Ç¶„É≥„Éà'
    })[screen];
    ({
      main: renderMainScreen, schedule: renderScheduleScreen, inventory: renderInventoryScreen,
      diary: renderDiaryScreen, account: renderAccountScreen
    })[screen](activeScreen);
  }
  function renderCurrentScreen(){ document.querySelector('button[data-screen="main"]').click(); }

  /* ===== „Éõ„Éº„É† ===== */
  function renderMainScreen(container){
    container.innerHTML = `
      <div class="condition-chips">
        <div class="chip-group">
          <label>ËÇå:</label>
          <div class="chips" data-group="skin">
            <button data-value="bad">Ëçí„Çå</button>
            <button data-value="normal">ÊôÆÈÄö</button>
            <button data-value="good">ËâØ„ÅÑ</button>
          </div>
          <button id="detail-skin-btn" class="text-xs p-1 ml-1 rounded-full bg-gray-200 w-6 h-6">+</button>
        </div>
        <div class="chip-group"><label>„É°„Ç§„ÇØ:</label>
          <div class="chips" data-group="makeup"><button data-value="yes">„ÅÇ„Çä</button><button data-value="no">„Å™„Åó</button></div>
        </div>
        <div class="chip-group"><label>Â§ñÂá∫:</label>
          <div class="chips" data-group="outing"><button data-value="yes">„ÅÇ„Çä</button><button data-value="no">„Å™„Åó</button></div>
        </div>
      </div>

      <div id="recalculating-feedback" class="text-center text-sm text-gray-500 mb-4 h-5"></div>
      <div id="suggestion-card" class="hidden card text-sm"></div>
      <div id="manual-container"></div>

      <!-- „É¨„Ç∑„ÉîÂèçÊò†„É¢„Éº„ÉÄ„É´ -->
      <div id="apply-recipe-modal" class="hidden fixed inset-0 bg-black/30 flex items-end sm:items-center sm:justify-center z-50">
        <div class="bg-white w-full sm:w-[520px] rounded-t-2xl sm:rounded-2xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">‰ªäÊó•„ÅÆ„É¨„Ç∑„Éî„ÇíÈÅ∏„Å∂</h3>
            <button id="close-apply-modal" class="text-gray-500 text-lg">‚úï</button>
          </div>
          <div class="space-y-3">
            <button id="apply-yesterday" class="w-full btn-primary">Êò®Êó•„ÅÆ„É¨„Ç∑„Éî„ÇíÂèçÊò†</button>
            <div class="mt-2">
              <div class="flex gap-2 mb-2">
                <button id="tab-saved" class="px-3 py-1 rounded bg-gray-100 text-sm">‰øùÂ≠òÊ∏à„Åø</button>
                <button id="tab-history" class="px-3 py-1 rounded bg-gray-100 text-sm">Â±•Ê≠¥</button>
              </div>
              <div id="list-saved" class="space-y-2"></div>
              <div id="list-history" class="space-y-2 hidden"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- why„É¢„Éº„ÉÄ„É´ -->
      <div id="why-modal" class="hidden fixed inset-0 bg-black/30 flex items-center justify-center z-50">
        <div class="bg-white w-[90%] sm:w-[480px] rounded-2xl p-4">
          <div id="why-text" class="text-sm"></div>
          <div class="text-right mt-3"><button id="close-why" class="btn-primary">OK</button></div>
        </div>
      </div>
    `;

    // Êù°‰ª∂UI
    container.querySelectorAll('.chips').forEach(div => {
      div.querySelectorAll('button').forEach(btn => {
        const group = div.dataset.group;
        btn.classList.toggle('selected', btn.dataset.value === state.dailyConditions[group]);
      });
      div.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        state.dailyConditions[div.dataset.group] = e.target.dataset.value;
        if (state.today) state.today.conditions = { ...state.dailyConditions };
        saveState();
        showRecalc(() => { recalcTodayByRules(); renderManual(); });
        div.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
        e.target.classList.add('selected');
      });
    });

    // ÂàùÊúütoday
    if (!state.today || (!state.today.am.length && !state.today.pm.length)) {
      state.today = makeTodayFromRules(); saveState();
    }
    renderManual(); refreshSuggestionCard();
  }

  function renderManual(){
    const wrap = document.getElementById('manual-container'); if(!wrap || !state.today) return;
    const { amMinutes, pmMinutes } = calcDurations(state.today);
    const amHTML = createRoutineSectionHTML('‚òÄÔ∏è Êúù„ÅÆ„É¨„Ç∑„Éî', state.today.am, amMinutes, 'AM');
    const pmHTML = createRoutineSectionHTML('üåô Â§ú„ÅÆ„É¨„Ç∑„Éî', state.today.pm, pmMinutes, 'PM');
    wrap.innerHTML = amHTML + pmHTML;

    // „Ç§„Éô„É≥„Éà
    wrap.querySelectorAll('[data-action="add-step"]').forEach(b => b.addEventListener('click', () => onAddStep(b.dataset.time)));
    wrap.querySelectorAll('[data-action="remove-today"]').forEach(b => b.addEventListener('click', () => onRemoveToday(b.dataset.time, b.dataset.id)));
    wrap.querySelectorAll('[data-action="why"]').forEach(b => b.addEventListener('click', () => openWhy(b.dataset.id)));
    wrap.querySelectorAll('[data-action="section-menu"]').forEach(b => b.addEventListener('click', () => openSectionMenu(b.dataset.time)));
    wrap.querySelectorAll('[data-action="complete-all"]').forEach(b => b.addEventListener('click', () => onCompleteAll(b.dataset.time)));
    wrap.querySelectorAll('[data-action="share-section"]').forEach(b => b.addEventListener('click', () => onShareSection(b.dataset.time)));
  }

  function createRoutineSectionHTML(title, steps, minutes, timeOfDay){
    const visibleSteps = steps.filter(s => !s.hidden);
    const listHTML = visibleSteps.map(s => taskRowHTML(s, timeOfDay)).join('');
    return `
      <div class="card p-5 mb-4">
        <div class="flex items-center justify-between">
          <h3 class="font-bold text-lg">${title}</h3>
          <div class="flex items-center gap-3">
            <span class="text-xs text-gray-500">Êú¨Êó•„ÅÆÁõÆÂÆâÔºö${minutes}ÂàÜ</span>
            <button class="text-xs px-2 py-1 border rounded" data-action="section-menu" data-time="${timeOfDay}">‚Ä¶</button>
          </div>
        </div>
        <ul class="mt-3 space-y-2">
          ${listHTML || `<li class="text-sm text-gray-400">‰ªäÊó•„ÅØË°®Á§∫„Åô„Çã„Çπ„ÉÜ„ÉÉ„Éó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</li>`}
        </ul>
        <div class="mt-4 grid grid-cols-2 gap-2">
          <button class="btn-secondary w-full text-sm" data-action="add-step" data-time="${timeOfDay}">Ôºã „Çπ„ÉÜ„ÉÉ„Éó„ÇíËøΩÂä†</button>
          <span></span>
        </div>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <button class="btn-primary w-full text-sm" data-action="complete-all" data-time="${timeOfDay}">ÂÖ®„Å¶ÂÆå‰∫Ü</button>
          <button class="btn-secondary w-full text-sm" data-action="share-section" data-time="${timeOfDay}">„Åì„ÅÆ„É¨„Ç∑„Éî„Çí„Ç∑„Çß„Ç¢</button>
        </div>
      </div>
    `;
  }

  function taskRowHTML(step, timeOfDay){
    const p = masterInventory.find(i => i.id === step.productId);
    const name = p ? p.name : step.stepType;
    const cate = p ? p.category : step.stepType;
    const img  = p?.image || 'https://placehold.co/100x100/cccccc/FFFFFF?text=..';
    const startDate = state.products.find(x => x.id === p?.id)?.startDate;
    const daysSince = startDate ? daysBetween(new Date(startDate), new Date()) : null;
    const tip = daysSince != null ? `ÈñãÂßã„Åã„Çâ${daysSince}Êó•` : '';
    const reason = step.why ? `<div class="reason-badge info">${step.why}</div>` : '';
    const warnWontUse = p && (state.products.find(x=>x.id===p.id)?.wontUse);
    const wontBadge = warnWontUse ? `<div class="reason-badge warning">‚Äª „Åì„ÅÆË£ΩÂìÅ„ÅØ„Äå„ÇÇ„ÅÜ‰Ωø„Çè„Å™„ÅÑ„ÄçË®≠ÂÆö„Åß„Åô</div>` : '';

    return `
      <li class="task-item">
        <input type="checkbox" class="task-checkbox" />
        <img src="${img}" alt="${name}" class="w-12 h-12 rounded-lg" />
        <div class="flex-grow ml-4">
          <p class="font-bold text-sm">
            <span class="step-name">${name}</span>
            ${tip ? `<span class="ml-2 text-[10px] text-gray-500 border rounded px-1">${tip}</span>` : ''}
          </p>
          <p class="text-xs text-gray-500">${cate}</p>
          ${reason}${wontBadge}
        </div>
        <div class="flex gap-2">
          <button class="text-xs px-2 py-1 border rounded" data-action="why" data-id="${step.id}">i</button>
          <button class="text-xs px-2 py-1 border rounded" data-action="remove-today" data-time="${timeOfDay}" data-id="${step.id}">‰ªäÊó•„Å†„ÅëÂ§ñ„Åô</button>
        </div>
      </li>
    `;
  }

  /* ===== „Çª„ÇØ„Ç∑„Éß„É≥Êìç‰Ωú ===== */
  function openSectionMenu(time){
    const pick = prompt(
      `${time}„ÅÆÊìç‰Ωú„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑÔºö\n` +
      `1: „Åì„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ„É¨„Ç∑„Éî„ÇíÂèçÊò†\n` +
      `2: „Åì„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆ„É¨„Ç∑„Éî„Çí‰øùÂ≠ò`
    );
    if (pick === '1') openApplyModal(time);
    if (pick === '2') onSaveCurrentAsRecipe(time);
  }
  function onCompleteAll(time){
    const cardIdx = time === 'AM' ? 1 : 2;
    const list = document.querySelectorAll(`#manual-container .card:nth-of-type(${cardIdx}) .task-checkbox`);
    list.forEach(cb => cb.checked = true);
  }
  function onShareSection(time){
    const steps = (time === 'AM' ? state.today.am : state.today.pm).filter(s => !s.hidden);
    const lines = steps.map(s => {
      const p = masterInventory.find(m => m.id === s.productId);
      const label = p ? `${p.category}Ôºö${p.name}` : s.stepType;
      return `„Éª${label}`;
    }).join('\n');
    const text = `${time}„ÅÆ„É¨„Ç∑„Éî\n${lines || 'Ôºà„Çπ„ÉÜ„ÉÉ„Éó„Å™„ÅóÔºâ'}`;
    if (navigator.share) { navigator.share({ text }).catch(()=>{}); }
    else { navigator.clipboard.writeText(text).then(()=>alert('„É¨„Ç∑„Éî„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü')); }
  }

  /* ===== „É´„Éº„É´ ===== */
  function makeTodayFromRules(){
    const date = isoDate(new Date());
    const baseAM = [
      asStep('Ê¥óÈ°î','item2','AM'),
      asStep('ÂåñÁ≤ßÊ∞¥','item4','AM'),
      asStep('‰π≥Ê∂≤','item6','AM'),
    ];
    const basePM = [
      maybeAsStep('ÈÖµÁ¥†Ê¥óÈ°î','item3','PM'),
      asStep('Ê¥óÈ°î','item2','PM'),
      asStep('ÂåñÁ≤ßÊ∞¥','item4','PM'),
      asStep('‰π≥Ê∂≤','item6','PM'),
    ];
    const today = {
      date, conditions:{ ...state.dailyConditions },
      am: baseAM, pm: basePM,
      overrides:{ amRemove:[], pmRemove:[], amAdd:[], pmAdd:[] }, whyMap:{}
    };
    applyRulesInPlace(today);
    return today;
  }

  function recalcTodayByRules(){ if(!state.today) return; applyRulesInPlace(state.today); saveState(); refreshSuggestionCard(); }

  function applyRulesInPlace(day){
    [...day.am, ...day.pm].forEach(s => { s.hidden = false; if(!day.whyMap[s.id]) s.why = undefined; });
    const cond = day.conditions;

    // Â§ñÂá∫ ‚Üí AM„Å´Êó•ÁÑº„ÅëÊ≠¢„ÇÅÔºàwontUseÈô§Â§ñÔºâ
    if (cond.outing === 'yes') {
      const hasSPF = day.am.some(s => !s.hidden && masterInventory.find(mi => mi.id===s.productId)?.category==='Êó•ÁÑº„ÅëÊ≠¢„ÇÅ');
      if (!hasSPF) {
        const ownedSPF = state.products
          .filter(p => !p.wontUse)
          .map(x => masterInventory.find(m=>m.id===x.id))
          .find(m => m?.category==='Êó•ÁÑº„ÅëÊ≠¢„ÇÅ');
        if (ownedSPF) day.am.push(asStep('Êó•ÁÑº„ÅëÊ≠¢„ÇÅ', ownedSPF.id, 'AM', 'Â§ñÂá∫„ÅÆ„Åü„ÇÅËøΩÂä†„Åó„Åæ„Åó„Åü'));
      }
    }
    // „É°„Ç§„ÇØ ‚Üí PM„Å´„ÇØ„É¨„É≥„Ç∏„É≥„Ç∞ÔºàwontUseÈô§Â§ñÔºâ
    if (cond.makeup === 'yes') {
      const hasCLR = day.pm.some(s => !s.hidden && masterInventory.find(mi => mi.id===s.productId)?.category==='„ÇØ„É¨„É≥„Ç∏„É≥„Ç∞');
      if (!hasCLR) {
        const ownedCLR = state.products
          .filter(p => !p.wontUse)
          .map(x => masterInventory.find(m=>m.id===x.id))
          .find(m => m?.category==='„ÇØ„É¨„É≥„Ç∏„É≥„Ç∞');
        if (ownedCLR) day.pm.unshift(asStep('„ÇØ„É¨„É≥„Ç∏„É≥„Ç∞', ownedCLR.id, 'PM', '„É°„Ç§„ÇØ„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅËøΩÂä†„Åó„Åæ„Åó„Åü'));
      }
    }
    // ËÇåËçí„Çå ‚Üí ÈÖµÁ¥†/ÈÖ∏/„É¨„ÉÅ„Éé„Ç§„ÉâÈö†„Åô & ÁæéÂÆπÊ∂≤„Å´ÁêÜÁî±
    if (cond.skin === 'bad') {
      const hideTags = ['enzyme','acid','retinoid'];
      [...day.am, ...day.pm].forEach(s => {
        const prod = masterInventory.find(mi => mi.id===s.productId);
        if (!prod) return;
        const tags = prod.tags || [];
        if (tags.some(t => hideTags.includes(t)) || prod.category==='ÈÖµÁ¥†Ê¥óÈ°î') {
          s.hidden = true; s.why = 'ËÇå„ÅåËçí„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅÂ§ñ„Åó„Å¶„ÅÑ„Åæ„Åô';
        }
        if (prod.category==='ÁæéÂÆπÊ∂≤') s.why = s.why || 'ËÇåËçí„Çå„Ç±„Ç¢„ÅÆ„Åü„ÇÅË°®Á§∫„Åó„Å¶„ÅÑ„Åæ„Åô';
      });
    }

    // ÂΩìÊó•„Å†„Åë„ÅÆÈô§Â§ñ
    day.am.forEach(s => { if (day.overrides.amRemove.includes(s.id)) s.hidden = true; });
    day.pm.forEach(s => { if (day.overrides.pmRemove.includes(s.id)) s.hidden = true; });
  }

  /* ===== „Çπ„ÉÜ„ÉÉ„ÉóÁîüÊàê„ÉªÊôÇÈñì ===== */
  function uuid(){ return Math.random().toString(36).slice(2,10); }
  function asStep(stepType, productId, tod, why){
    const prod = masterInventory.find(i => i.id===productId);
    return { id:uuid(), timeOfDay:tod, order:0, stepType, productId,
      durationMin: DURATION_MIN[prod?.category || stepType] || 1, hidden:false, why };
  }
  function maybeAsStep(stepType, productId, tod){ const prod = masterInventory.find(i => i.id===productId); if(!prod) return null; return asStep(stepType, productId, tod); }
  function calcDurations(day){
    const sum = (arr)=>arr.filter(s=>!s.hidden).reduce((a,s)=>a+(s.durationMin||1),0);
    return { amMinutes: sum(day.am), pmMinutes: sum(day.pm) };
  }

  /* ===== ÂΩìÊó•„Å†„Åë„ÅÆÂ¢óÊ∏õ ===== */
  function onRemoveToday(tod, stepId){
    if(!state.today) return;
    const key = tod==='AM' ? 'amRemove':'pmRemove';
    if (!state.today.overrides[key].includes(stepId)) state.today.overrides[key].push(stepId);
    saveState(); renderManual();
  }
  function onAddStep(tod){
    const category = prompt('ËøΩÂä†„Åô„Çã„Ç´„ÉÜ„Ç¥„É™Ôºà‰æãÔºöÁæéÂÆπÊ∂≤, ‰π≥Ê∂≤, Êó•ÁÑº„ÅëÊ≠¢„ÇÅ, Ê¥óÈ°î, „ÇØ„É¨„É≥„Ç∏„É≥„Ç∞, ÈÖµÁ¥†Ê¥óÈ°î, ÂåñÁ≤ßÊ∞¥Ôºâ');
    if(!category) return;
    const owned = state.products
      .filter(x => !x.wontUse) // „ÇÇ„ÅÜ‰Ωø„Çè„Å™„ÅÑ„ÇíÈô§Â§ñ
      .map(x => masterInventory.find(m=>m.id===x.id))
      .filter(Boolean)
      .filter(m => m.category === category.trim());
    if(!owned.length){ alert(`„Äå${category}„Äç„ÅÆÁôªÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Ç≥„Çπ„É°‰∏ÄË¶ß„Åã„ÇâËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`); return; }
    const names = owned.map((m,i)=>`${i+1}: ${m.name}`).join('\n');
    const pick = prompt(`ËøΩÂä†„Åô„ÇãË£ΩÂìÅ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑÔºö\n${names}`);
    const idx = Number(pick)-1; if(isNaN(idx)||idx<0||idx>=owned.length) return;
    const chosen = owned[idx];
    const step = asStep(chosen.category, chosen.id, tod, 'ÊâãÂãï„ÅßËøΩÂä†„Åó„Åæ„Åó„Åü');
    if(tod==='AM') state.today.am.push(step); else state.today.pm.push(step);
    saveState(); renderManual();
  }

  /* ===== „É¨„Ç∑„Éî‰øùÂ≠ò/ÂèçÊò†ÔºàAM/PMÂØæÂøúÔºâ ===== */
  function openApplyModal(time /* 'AM' | 'PM' | undefined */){
    const modal = document.getElementById('apply-recipe-modal');
    modal.classList.remove('hidden');
    document.getElementById('close-apply-modal').onclick = () => modal.classList.add('hidden');

    const btnYesterday = document.getElementById('apply-yesterday');
    const yesterday = state.history[0];
    btnYesterday.disabled = !yesterday;
    btnYesterday.classList.toggle('opacity-50', !yesterday);
    btnYesterday.onclick = () => {
      if(!yesterday) return;
      applyRecipeToToday(yesterday, time);
      saveState(); modal.classList.add('hidden'); renderManual(); refreshSuggestionCard();
    };

    const tabSaved = document.getElementById('tab-saved');
    const tabHistory = document.getElementById('tab-history');
    const listSaved = document.getElementById('list-saved');
    const listHistory = document.getElementById('list-history');

    function recipeRow(r, onApply){
      const when = (r.createdAt||'').slice(0,10);
      const steps = (r.am?.filter(s=>!s.hidden).length||0) + (r.pm?.filter(s=>!s.hidden).length||0);
      const name = r.name || 'ÁÑ°È°å„É¨„Ç∑„Éî';
      return `
        <div class="flex items-center justify-between border rounded p-2">
          <div><div class="text-sm font-medium">${name}</div><div class="text-xs text-gray-500">${when} / ${steps}„Çπ„ÉÜ„ÉÉ„Éó</div></div>
          <button class="btn-secondary text-xs" onclick="(${onApply.toString()})()">ÂèçÊò†</button>
        </div>
      `;
    }
    function renderSaved(){
      listSaved.innerHTML = (state.savedRecipes||[]).map(r => recipeRow(r, () => {
        applyRecipeToToday(r, time); saveState(); modal.classList.add('hidden'); renderManual(); refreshSuggestionCard();
      })).join('') || `<p class="text-sm text-gray-500">‰øùÂ≠òÊ∏à„Åø„É¨„Ç∑„Éî„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>`;
    }
    function renderHistory(){
      const items = (state.history||[]).slice(0,10);
      listHistory.innerHTML = items.map(r => recipeRow(r, () => {
        applyRecipeToToday(r, time); saveState(); modal.classList.add('hidden'); renderManual(); refreshSuggestionCard();
      })).join('') || `<p class="text-sm text-gray-500">Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>`;
    }
    function activate(tab){ if(tab==='saved'){ listSaved.classList.remove('hidden'); listHistory.classList.add('hidden'); } else { listSaved.classList.add('hidden'); listHistory.classList.remove('hidden'); } }
    tabSaved.onclick = () => activate('saved'); tabHistory.onclick = () => activate('history');
    renderSaved(); renderHistory(); activate('saved');
  }

  function onSaveCurrentAsRecipe(time /* 'AM' | 'PM' | undefined */){
    if(!state.today) return;
    const name = prompt('„É¨„Ç∑„ÉîÂêçÔºà‰æãÔºöËÇåËçí„ÇåÁî®PMÔºâ');
    const rec = { id: uuid(), name: name || undefined, createdAt: new Date().toISOString(), am: deepClone(state.today.am), pm: deepClone(state.today.pm) };
    if (time === 'AM') rec.pm = []; // ÁâáÂÅ¥‰øùÂ≠ò
    if (time === 'PM') rec.am = [];
    state.savedRecipes.unshift(rec); saveState(); alert('‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
  }

  function applyRecipeToToday(recipe, time /* optional */){
    const clone = dayFromRecipe(recipe);
    if(!state.today) state.today = makeTodayFromRules();
    if(time==='AM'){ state.today.am = clone.am; }
    else if(time==='PM'){ state.today.pm = clone.pm; }
    else { state.today.am = clone.am; state.today.pm = clone.pm; }
    state.today.conditions = { ...state.dailyConditions };
    applyRulesInPlace(state.today);
  }

  function dayFromRecipe(r){
    return {
      date: isoDate(new Date()),
      conditions: { ...state.dailyConditions },
      am: deepClone(r.am||[]), pm: deepClone(r.pm||[]),
      overrides:{ amRemove:[], pmRemove:[], amAdd:[], pmAdd:[] }, whyMap:{}
    };
  }

  /* ===== ‰∏çË∂≥ÊèêÊ°à ===== */
  function refreshSuggestionCard(){
    const card = document.getElementById('suggestion-card'); if(!card || !state.today) return;
    card.classList.add('hidden');
    const need = [];
    if (state.today.conditions.outing === 'yes') {
      const hasSPF = state.today.am.some(s => !s.hidden && masterInventory.find(m=>m.id===s.productId)?.category==='Êó•ÁÑº„ÅëÊ≠¢„ÇÅ');
      if (!hasSPF) need.push('Êó•ÁÑº„ÅëÊ≠¢„ÇÅ');
    }
    if (state.today.conditions.makeup === 'yes') {
      const hasCLR = state.today.pm.some(s => !s.hidden && masterInventory.find(m=>m.id===s.productId)?.category==='„ÇØ„É¨„É≥„Ç∏„É≥„Ç∞');
      if (!hasCLR) need.push('„ÇØ„É¨„É≥„Ç∏„É≥„Ç∞');
    }
    const lacks = need.filter(cat =>
      !state.products
        .filter(p => !p.wontUse) // „ÇÇ„ÅÜ‰Ωø„Çè„Å™„ÅÑÈô§Â§ñ
        .some(p => masterInventory.find(m => m.id===p.id)?.category === cat)
    );
    if (!lacks.length) return;
    const cats = [...new Set(lacks)].join('„Éª');
    card.innerHTML = `
      <div class="flex items-center justify-between">
        <div><strong>${cats}</strong> „ÅåÊú™ÁôªÈå≤„Åß„Åô„ÄÇËøΩÂä†„Åó„Åæ„Åô„ÅãÔºü</div>
        <button class="btn-primary text-xs" id="add-missing">ËøΩÂä†</button>
      </div>
    `;
    card.classList.remove('hidden');
    document.getElementById('add-missing').onclick = () => {
      const options = masterInventory.filter(m => lacks.includes(m.category))
        .map((m,i)=>`${i+1}: ${m.category} / ${m.name}`).join('\n');
      const pick = prompt(`ËøΩÂä†„Åô„ÇãË£ΩÂìÅ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑÔºö\n${options}`);
      const idx = Number(pick)-1;
      const pool = masterInventory.filter(m => lacks.includes(m.category));
      if(!isNaN(idx) && pool[idx]){
        if(!state.products.some(p => p.id===pool[idx].id)) state.products.push({ id: pool[idx].id, wontUse:false });
        saveState(); recalcTodayByRules(); renderManual();
      }
    };
  }

  /* ===== WHY ===== */
  function openWhy(stepId){
    const step = [...(state.today?.am||[]), ...(state.today?.pm||[])].find(s => s.id===stepId);
    const text = step?.why || '„Åì„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆÁêÜÁî±„ÅØÁâπ„Å´„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
    const modal = document.getElementById('why-modal');
    document.getElementById('why-text').textContent = text;
    modal.classList.remove('hidden');
    document.getElementById('close-why').onclick = () => modal.classList.add('hidden');
  }

  /* ===== Êó•‰ªò„É≠„Éº„É´„Ç™„Éº„Éê„Éº ===== */
  function rolloverIfNeeded(){
    const todayISO = isoDate(new Date());
    if (!state.today || state.today.date === todayISO) return;
    state.history.unshift({ id: uuid(), createdAt: state.today.date + 'T00:00:00Z', am: deepClone(state.today.am), pm: deepClone(state.today.pm) });
    state.today = makeTodayFromRules(); saveState();
  }

  /* ===== „Çπ„Ç±„Ç∏„É•„Éº„É´/„ÉÄ„Ç§„Ç¢„É™„Éº/„Ç¢„Ç´„Ç¶„É≥„ÉàÔºàÁ∞°ÊòìÔºâ ===== */
  function renderScheduleScreen(container){
    container.innerHTML = `<div class="card"><h2>Á∞°Êòì„Çπ„Ç±„Ç∏„É•„Éº„É´</h2><p class="text-sm text-gray-500">ÈñãÁô∫‰∏≠„Åß„Åô</p></div>`;
  }
  function renderDiaryScreen(container){
    const list = (state.history||[]).slice(0,10);
    const html = list.map(r => {
      const steps = (r.am?.filter(s=>!s.hidden).length||0) + (r.pm?.filter(s=>!s.hidden).length||0);
      return `<div class="border rounded p-3 mb-3">
        <div class="text-sm font-semibold">${(r.createdAt||'').slice(0,10)}</div>
        <div class="text-xs text-gray-500">${steps} „Çπ„ÉÜ„ÉÉ„Éó</div>
      </div>`;
    }).join('') || `<p class="text-sm text-gray-500">„Åæ„Å†Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>`;
    container.innerHTML = `<div class="card"><h2>„ÉÄ„Ç§„Ç¢„É™„Éº</h2>${html}</div>`;
  }
  function renderAccountScreen(container){
    container.innerHTML = `<div class="card"><h2>„Ç¢„Ç´„Ç¶„É≥„Éà</h2><p>„Çµ„Ç§„É≥„Ç¢„ÉÉ„Éó‰∏çË¶Å„Åß‰Ωø„Åà„Åæ„Åô„ÄÇ</p></div>`;
  }

  /* ===== „Ç≥„Çπ„É°‰∏ÄË¶ßÔºàÊ§úÁ¥¢/ËøΩÂä†/ÊâÄÊúâ/„ÇÇ„ÅÜ‰Ωø„Çè„Å™„ÅÑ/ÈñãÂßãÊó•/ÂâäÈô§Ôºâ ===== */
  function renderInventoryScreen(container) {
    container.innerHTML = `
      <div class="card">
        <h2 class="flex items-center justify-between">
          <span>„Éû„Ç§„Ç≥„Çπ„É°</span>
          <div class="flex gap-2">
            <input id="inv-search" type="search" placeholder="Ê§úÁ¥¢Ôºà„Éñ„É©„É≥„Éâ/ÂïÜÂìÅ/„Ç´„ÉÜ„Ç¥„É™Ôºâ" class="border rounded px-3 py-1 text-sm w-40 sm:w-64" />
            <button id="inv-add" class="btn-primary text-sm">Ôºã „Ç≥„Çπ„É°„ÇíËøΩÂä†</button>
          </div>
        </h2>
        <div id="inv-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-3"></div>
      </div>

      <!-- ËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
      <div id="inv-modal" class="hidden fixed inset-0 bg-black/30 flex items-end sm:items-center sm:justify-center z-50">
        <div class="bg-white w-full sm:w-[520px] rounded-t-2xl sm:rounded-2xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">„Ç≥„Çπ„É°„ÇíËøΩÂä†</h3>
            <button id="inv-modal-close" class="text-gray-500 text-lg">‚úï</button>
          </div>
          <div class="grid gap-3 text-sm">
            <label class="grid gap-1">
              <span>„Éñ„É©„É≥„Éâ</span>
              <input id="inv-brand" class="border rounded px-3 py-2" placeholder="‰æãÔºö„Ç™„É´„Éì„Çπ" />
            </label>
            <label class="grid gap-1">
              <span>ÂïÜÂìÅÂêç</span>
              <input id="inv-name" class="border rounded px-3 py-2" placeholder="‰æãÔºö„Ç™„É´„Éì„Çπ„É¶„Éº" />
            </label>
            <label class="grid gap-1">
              <span>„Ç´„ÉÜ„Ç¥„É™</span>
              <input id="inv-category" class="border rounded px-3 py-2" placeholder="‰æãÔºöÂåñÁ≤ßÊ∞¥ / ‰π≥Ê∂≤ / Ê¥óÈ°î / „ÇØ„É¨„É≥„Ç∏„É≥„Ç∞ ‚Ä¶" />
            </label>
            <label class="grid gap-1">
              <span>ÈñãÂßãÊó•Ôºà‰ªªÊÑèÔºâ</span>
              <input id="inv-start" type="date" class="border rounded px-3 py-2" />
            </label>
            <div class="text-right mt-2">
              <button id="inv-save" class="btn-primary">ËøΩÂä†„Åô„Çã</button>
            </div>
          </div>
        </div>
      </div>
    `;

    const grid   = container.querySelector('#inv-grid');
    const search = container.querySelector('#inv-search');
    const addBtn = container.querySelector('#inv-add');

    const render = () => {
      const q = (search.value || '').trim().toLowerCase();
      const ownedIds = new Set(state.products.map(p => p.id));
      const items = masterInventory.filter(m => ownedIds.has(m.id));

      const filtered = !q ? items : items.filter(m => {
        const txt = [m.name, m.category].join(' ').toLowerCase();
        return txt.includes(q);
      });

      grid.innerHTML = filtered.map(item => {
        const prodState = state.products.find(p => p.id === item.id);
        const start = prodState?.startDate || '';
        const wont = !!prodState?.wontUse;
        const initials = (item.name || '?').split(/\s+/).map(s=>s[0]).slice(0,2).join('').toUpperCase();
        return `
          <div class="border rounded p-3 flex flex-col gap-2 ${wont ? 'opacity-60 grayscale' : ''}">
            <div class="w-16 h-16 rounded-md grid place-items-center text-white text-lg font-bold mx-auto"
                 style="background:${avatarColor(item.category)}">${initials}</div>
            <div class="text-center">
              <p class="font-bold text-sm">${item.name}</p>
              <p class="text-xs text-gray-500">${item.category}</p>
            </div>
            <div class="text-xs">
              <label class="block">ÈñãÂßãÊó•Ôºà‰ªªÊÑèÔºâ
                <input type="date" value="${start}" data-pid="${item.id}" class="mt-1 w-full border rounded px-2 py-1 text-sm"/>
              </label>
            </div>
            <div class="flex items-center justify-between text-xs mt-1">
              <label class="flex items-center gap-1">
                <input type="checkbox" data-own="${item.id}" ${prodState ? 'checked' : ''}/>
                ÊâÄÊúâ‰∏≠
              </label>
              <label class="flex items-center gap-1">
                <input type="checkbox" data-wont="${item.id}" ${wont ? 'checked' : ''}/>
                „ÇÇ„ÅÜ‰Ωø„Çè„Å™„ÅÑ
              </label>
            </div>
            <div class="flex items-center justify-end text-xs">
              ${item.custom ? `<button class="px-2 py-1 border rounded" data-del="${item.id}">ÂâäÈô§</button>` : ''}
            </div>
          </div>
        `;
      }).join('') || `<p class="text-sm text-gray-500">ÊâÄÊúâ„Åó„Å¶„ÅÑ„Çã„Ç≥„Çπ„É°„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„ÄåÔºã „Ç≥„Çπ„É°„ÇíËøΩÂä†„Äç„Åã„ÇâÁôªÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>`;

      // „Éè„É≥„Éâ„É©
      grid.querySelectorAll('input[type="date"]').forEach(inp => {
        inp.addEventListener('change', () => {
          const pid = inp.dataset.pid;
          const rec = state.products.find(p => p.id === pid);
          if (rec) rec.startDate = inp.value || undefined;
          saveState();
        });
      });
      grid.querySelectorAll('input[data-own]').forEach(chk => {
        chk.addEventListener('change', () => {
          const pid = chk.dataset.own;
          if (chk.checked) {
            if (!state.products.some(p => p.id === pid)) state.products.push({ id: pid, wontUse:false });
          } else {
            state.products = state.products.filter(p => p.id !== pid);
          }
          saveState(); render();
        });
      });
      grid.querySelectorAll('input[data-wont]').forEach(chk => {
        chk.addEventListener('change', () => {
          const pid = chk.dataset.wont;
          const rec = state.products.find(p => p.id === pid);
          if (rec) rec.wontUse = chk.checked;
          saveState(); render();
        });
      });
      grid.querySelectorAll('button[data-del]').forEach(btn => {
        btn.addEventListener('click', () => {
          const pid = btn.dataset.del;
          const item = masterInventory.find(m => m.id === pid);
          if (!item?.custom) return;
          if (!confirm(`„Äå${item.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºüÔºàÂ±•Ê≠¥„Å´„ÅØÂΩ±Èüø„Åó„Åæ„Åõ„ÇìÔºâ`)) return;
          state.products = state.products.filter(p => p.id !== pid);
          const idx = masterInventory.findIndex(m => m.id === pid);
          if (idx >= 0) masterInventory.splice(idx, 1);
          saveState(); render();
        });
      });
    };

    // Ê§úÁ¥¢
    search.addEventListener('input', render);

    // ËøΩÂä†„É¢„Éº„ÉÄ„É´
    const modal = container.querySelector('#inv-modal');
    const close = container.querySelector('#inv-modal-close');
    const save  = container.querySelector('#inv-save');
    const $b = sel => container.querySelector(sel);

    addBtn.addEventListener('click', () => { modal.classList.remove('hidden'); });
    close.addEventListener('click', () => { modal.classList.add('hidden'); });

    save.addEventListener('click', () => {
      const brand = $b('#inv-brand').value.trim();
      const name  = $b('#inv-name').value.trim();
      const cat   = $b('#inv-category').value.trim();
      const start = $b('#inv-start').value;

      if (!name || !cat) { alert('ÂïÜÂìÅÂêç„Å®„Ç´„ÉÜ„Ç¥„É™„ÅØÂøÖÈ†à„Åß„Åô'); return; }

      const id = uuid();
      masterInventory.push({
        id, category: cat, name: brand ? `${brand} ${name}` : name,
        image: 'https://placehold.co/100x100/777/FFFFFF?text=NEW', custom: true
      });
      state.products.push({ id, startDate: start || undefined, wontUse:false });
      saveState();

      // „É™„Çª„ÉÉ„Éà
      $b('#inv-brand').value=''; $b('#inv-name').value=''; $b('#inv-category').value=''; $b('#inv-start').value='';
      modal.classList.add('hidden');
      render();
    });

    render();
  }

  /* ===== ÁßªË°å„ÉªËâ≤„ÉªÂÖ±ÈÄö ===== */
  function migrateProductsShape(){
    if (!Array.isArray(state.products)) return;
    state.products.forEach(p => {
      if (typeof p.wontUse === 'undefined') p.wontUse = false;
    });
    saveState();
  }
  function avatarColor(category){
    const colors = {
      '„ÇØ„É¨„É≥„Ç∏„É≥„Ç∞':'#8B6B61','Ê¥óÈ°î':'#111111','ÈÖµÁ¥†Ê¥óÈ°î':'#63C3C3',
      'ÂåñÁ≤ßÊ∞¥':'#368CCB','ÁæéÂÆπÊ∂≤':'#2D2D2D','‰π≥Ê∂≤':'#C9002B','Êó•ÁÑº„ÅëÊ≠¢„ÇÅ':'#F2BE22'
    };
    return colors[category] || '#888888';
  }
  function displayDate(){ const t = new Date(); document.getElementById('current-date').textContent = `${t.getFullYear()}Âπ¥${t.getMonth()+1}Êúà${t.getDate()}Êó•`; }
  function isoDate(d){ return d.toISOString().slice(0,10); }
  function daysBetween(a,b){ return Math.floor((+b - +a)/(1000*60*60*24)); }
  function deepClone(x){ return JSON.parse(JSON.stringify(x)); }
  function showRecalc(cb){ const el=document.getElementById('recalculating-feedback'); if(!el){cb();return;} el.textContent='„É¨„Ç∑„Éî„ÇíÂÜçË®àÁÆó‰∏≠...'; setTimeout(()=>{ el.textContent=''; cb(); },200); }
});
</script>



</body>
</html>




