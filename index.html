<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾è‚Œãƒ­ã‚¸ãƒƒã‚¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Playfair+Display:wght@500;600&family=Caveat&display=swap" rel="stylesheet">
    <style>
        :root {
            --canvas-bg: #FAFAF9;
            --surface-bg: #FFFFFF;
            --line-color: #E5E7EB;
            --ink-primary: #111827;
            --ink-secondary: #6B7280;
            --brand-accent: #BFA77B;
            --brand-support: #93C5FD;
            --success-color: #22C55E;
            --warning-color: #F59E0B;
            --heading-font: 'Playfair Display', serif;
            --body-font: 'Noto Sans JP', sans-serif;
            --radius-card: 12px;
            --shadow-card: 0 6px 20px rgba(0,0,0,0.07);
        }
        body { font-family: var(--body-font); background-color: var(--canvas-bg); color: var(--ink-primary); margin: 0; padding: 20px 20px 100px 20px; }
        #app-container { max-width: 600px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 20px; }
        header h1 { font-family: var(--heading-font); font-weight: 500; color: var(--ink-primary); }
        header h1 .accent { color: var(--brand-accent); }
        .card { background-color: var(--surface-bg); border-radius: var(--radius-card); padding: 25px; margin-bottom: 25px; box-shadow: var(--shadow-card); border: 1px solid var(--line-color); }
        h2 { font-family: var(--heading-font); font-weight: 500; margin-top: 0; margin-bottom: 20px; font-size: 1.3em; border-bottom: 1px solid var(--line-color); padding-bottom: 15px; }
        nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 600px; margin: 0 auto; display: flex; justify-content: space-around; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); border-top: 1px solid var(--line-color); padding: 10px 0; z-index: 100; }
        nav button { flex: 1; border: none; background-color: transparent; cursor: pointer; font-size: 0.8em; font-weight: 500; color: var(--ink-secondary); transition: all 0.3s ease; padding: 8px 0; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        nav button.active { color: var(--brand-support); }
        nav button .nav-icon { transition: transform 0.3s ease; }
        nav button.active .nav-icon { transform: scale(1.1); }
        button { border-radius: var(--radius-card); cursor: pointer; font-size: 0.9em; font-weight: 500; transition: all 0.2s ease-out; padding: 10px 16px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-primary { background-color: var(--brand-support); color: white; border: none; }
        .btn-secondary { background-color: var(--surface-bg); color: var(--brand-support); border: 1px solid var(--brand-support); }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .condition-chips { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; padding: 20px; background-color: var(--surface-bg); border-radius: var(--radius-card); box-shadow: var(--shadow-card); }
        .chip-group { display: flex; align-items: center; gap: 8px; }
        .chip-group label { font-size: 0.9em; font-weight: 500; color: var(--ink-secondary); min-width: 40px; }
        .chips { display: flex; background-color: var(--line-color); border-radius: 20px; padding: 4px; }
        .chips button { font-size: 0.8em; padding: 6px 14px; border-radius: 20px; color: var(--ink-secondary); border: none; background-color: transparent; box-shadow: none; }
        .chips button.selected { background-color: var(--brand-support); color: white; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .task-item { display: flex; align-items: center; padding: 12px; margin-bottom: 12px; background-color: var(--surface-bg); border-radius: var(--radius-card); transition: all 0.3s ease; border: 1px solid var(--line-color); }
        .task-item.completed { opacity: 0.6; }
        .task-checkbox { appearance: none; width: 24px; height: 24px; border: 2px solid var(--line-color); border-radius: 50%; margin-right: 15px; cursor: pointer; transition: all 0.2s ease; position: relative; flex-shrink: 0; }
        .task-checkbox:checked { background-color: var(--success-color); border-color: var(--success-color); }
        .task-checkbox:checked::after { content: 'âœ“'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; }
        .reason-badge { font-size: 0.7em; padding: 3px 8px; border-radius: 10px; margin-top: 4px; display: inline-block; font-weight: 500; }
        .reason-badge.info { background-color: #DBEAFE; color: #1E40AF; }
        .reason-badge.warning { background-color: #FEF3C7; color: #92400E; }
        .line-chart-container { width: 100%; height: 180px; }
    </style>
</head>
<body>
    <div id="app-container">
        <header>
            <h1 id="header-title">ä»Šæ—¥ã®ãƒ¬ã‚·ãƒ”</h1>
            <p id="current-date"></p>
        </header>
        <main>
            <div id="main-screen" class="screen active"></div>
            <div id="schedule-screen" class="screen"></div>
            <div id="inventory-screen" class="screen"></div>
            <div id="diary-screen" class="screen"></div>
            <div id="account-screen" class="screen"></div>
        </main>
        <nav>
            <button data-screen="main" class="active"><span class="nav-icon">ğŸ </span>ãƒ›ãƒ¼ãƒ </button>
            <button data-screen="schedule"><span class="nav-icon">ğŸ—“ï¸</span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</button>
            <button data-screen="inventory"><span class="nav-icon">ğŸ§´</span>ã‚³ã‚¹ãƒ¡</button>
            <button data-screen="diary"><span class="nav-icon">ğŸ“–</span>ãƒ€ã‚¤ã‚¢ãƒªãƒ¼</button>
            <button data-screen="account"><span class="nav-icon">ğŸ‘¤</span>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</button>
        </nav>
        <div id="modal-container"></div>
    </div>

<script>
/**
 * ç¾è‚Œãƒ­ã‚¸ãƒƒã‚¯ â€“ HTMLå˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ç‰ˆ æ‹¡å¼µã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * è¿½åŠ ã—ãŸä¸»ãªæ©Ÿèƒ½ï¼š
 * - ã€Œãƒ¬ã‚·ãƒ”ã‚’åæ˜ ã€ãƒœã‚¿ãƒ³ï¼ˆæ˜¨æ—¥ï¼ä¿å­˜æ¸ˆã¿ï¼å±¥æ­´ã‹ã‚‰é¸æŠï¼‰
 * - ã‚¢ã‚¤ãƒ†ãƒ å¢—æ¸›ï¼ˆå½“æ—¥ã ã‘åæ˜ ï¼‰
 * - æ‰€è¦æ™‚é–“ã®åˆç®—è¡¨ç¤ºï¼ˆAM/PMï¼‰
 * - ç†ç”±ï¼ˆwhyï¼‰ã‚¿ãƒƒãƒ—è¡¨ç¤º
 * - è£½å“ã®ã€Œé–‹å§‹ã‹ã‚‰Næ—¥ã€ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
 * - ä¸è¶³ã‚«ãƒ†ã‚´ãƒªã®ææ¡ˆï¼ˆå¿…è¦æ™‚ã®ã¿è¡¨ç¤ºï¼‰
 * - localStorageã« today / history / savedRecipes ã‚’ä¿å­˜
 */

document.addEventListener('DOMContentLoaded', () => {
  /* ========== åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆæ—¢å­˜ã® masterInventory ã¯æµç”¨ï¼‰ ========== */
  const masterInventory = [
    { id: 'item1', category: 'ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°', name: 'ã‚·ãƒ¥ã‚¦ ã‚¦ã‚¨ãƒ ãƒ©', image: 'https://placehold.co/100x100/A67B5B/FFFFFF?text=S', tags: ['makeup'] },
    { id: 'item2', category: 'æ´—é¡”', name: 'B.A ã‚¦ã‚©ãƒƒã‚·ãƒ¥ N', image: 'https://placehold.co/100x100/1A1A1A/FFFFFF?text=B.A' },
    { id: 'item3', category: 'é…µç´ æ´—é¡”', name: 'ã‚¹ã‚¤ã‚µã‚¤', image: 'https://placehold.co/100x100/63C3C3/FFFFFF?text=SU', schedule: { type: 'weekly', days: [2, 5] }, tags: ['enzyme'], reason: { type: 'warning', text: 'âš ï¸ è‚Œè’ã‚Œæ™‚ã¯OFF' } },
    { id: 'item4', category: 'åŒ–ç²§æ°´', name: 'ã‚ªãƒ«ãƒ“ã‚¹ãƒ¦ãƒ¼', image: 'https://placehold.co/100x100/368CCB/FFFFFF?text=O' },
    { id: 'item5', category: 'ç¾å®¹æ¶²', name: 'ãƒ©ãƒ³ã‚³ãƒ  ã‚¸ã‚§ãƒ‹ãƒ•ã‚£ãƒƒã‚¯', image: 'https://placehold.co/100x100/2D2D2D/FFFFFF?text=L', reason: { type: 'info', text: 'ğŸ›¡ï¸ è‚Œè’ã‚Œã‚±ã‚¢' } },
    { id: 'item6', category: 'ä¹³æ¶²', name: 'SK-II ã‚¹ã‚­ãƒ³ãƒ‘ãƒ¯ãƒ¼', image: 'https://placehold.co/100x100/C9002B/FFFFFF?text=SK' },
    { id: 'item7', category: 'æ—¥ç„¼ã‘æ­¢ã‚', name: 'ã‚¢ãƒãƒƒã‚µ', image: 'https://placehold.co/100x100/F2BE22/FFFFFF?text=AN', tags: ['spf'], reason: { type: 'info', text: 'â˜€ï¸ å¤–å‡ºã‚ã‚Šã®ãŸã‚' } },
  ];

  /* ========== æ‰€è¦æ™‚é–“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆåˆ†ï¼‰ ========== */
  const DURATION_MIN = {
    'ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°': 2, 'æ´—é¡”': 1, 'åŒ–ç²§æ°´': 1, 'ç¾å®¹æ¶²': 1, 'ä¹³æ¶²': 1, 'æ—¥ç„¼ã‘æ­¢ã‚': 1, 'é…µç´ æ´—é¡”': 2
  };

  /* ========== çŠ¶æ…‹ï¼ˆlocalStorage æ°¸ç¶šåŒ–ï¼‰ ========== */
  const LS_KEY = 'skincare.app.v1';

  /** @type {{
   *  dailyConditions: { skin:'bad'|'normal'|'good', makeup:'yes'|'no', outing:'yes'|'no' },
   *  products: Array<{id:string, startDate?:string}>,
   *  savedRecipes: Array<Recipe>,
   *  history: Array<Recipe>,          // éå»ç¢ºå®šãƒ¬ã‚·ãƒ”ï¼ˆæœ€æ–°ãŒå…ˆé ­ï¼‰
   *  today?: DayInstance
   * }} */
  let state = loadState() || initState();

  function initState() {
    const todayISO = isoDate(new Date());
    return {
      dailyConditions: { skin: 'normal', makeup: 'no', outing: 'no' },
      products: masterInventory.map(p => ({ id: p.id, startDate: undefined })), // æœ€åˆã¯é–‹å§‹æ—¥ãªã—
      savedRecipes: [], // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºä¿å­˜ã—ãŸãƒ¬ã‚·ãƒ”
      history: [],      // éå»ã®å½“æ—¥ç¢ºå®šãƒ¬ã‚·ãƒ”
      today: {
        date: todayISO,
        conditions: { skin: 'normal', makeup: 'no', outing: 'no' },
        // å½“æ—¥ã®ãƒ¬ã‚·ãƒ”ï¼ˆAM/PMï¼‰ã¯èµ·å‹•æ™‚ã«è‡ªå‹•ç”Ÿæˆ
        am: [], pm: [],
        overrides: { amRemove: [], pmRemove: [], amAdd: [], pmAdd: [] }, // å½“æ—¥ã ã‘ã®å¢—æ¸›
        whyMap: {} // stepId -> string
      }
    };
  }

  function saveState() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function loadState() {
    try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null; }
  }

  /* ========== DOMå‚ç…§ ========== */
  const dom = {
    headerTitle: document.getElementById('header-title'),
    dateElement: document.getElementById('current-date'),
    nav: document.querySelector('nav'),
    main: document.querySelector('main'),
    modalContainer: document.getElementById('modal-container'),
  };

  /* ========== åˆæœŸåŒ– ========== */
  initialize();

  function initialize() {
    displayDate();
    rolloverIfNeeded();
    dom.nav.addEventListener('click', onNavClick);
    renderCurrentScreen();
  }

  /* ========== ç”»é¢åˆ‡æ›¿ ========== */
  function onNavClick(e) {
    const btn = e.target.closest('button');
    if (!btn) return;
    const screen = btn.dataset.screen;
    dom.main.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    dom.nav.querySelectorAll('button').forEach(b => b.classList.remove('active'));
    const activeScreen = document.getElementById(`${screen}-screen`);
    activeScreen.classList.add('active');
    btn.classList.add('active');
    dom.headerTitle.innerHTML = ({
      main: `ä»Šæ—¥ã®<span class="accent">ãƒ¬ã‚·ãƒ”</span>`,
      schedule: 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«', inventory: 'ã‚³ã‚¹ãƒ¡ä¸€è¦§', diary: 'ãƒ€ã‚¤ã‚¢ãƒªãƒ¼', account: 'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ'
    })[screen];
    ({
      main: renderMainScreen, schedule: renderScheduleScreen, inventory: renderInventoryScreen,
      diary: renderDiaryScreen, account: renderAccountScreen
    })[screen](activeScreen);
  }

  function renderCurrentScreen() {
    // åˆæœŸã¯ main
    document.querySelector('button[data-screen="main"]').click();
  }

  /* ========== ãƒ¡ã‚¤ãƒ³ï¼ˆãƒ›ãƒ¼ãƒ ï¼‰ ========== */
  function renderMainScreen(container) {
    container.innerHTML = `
      <div class="condition-chips">
        <div class="chip-group">
          <label>è‚Œ:</label>
          <div class="chips" data-group="skin">
            <button data-value="bad">è’ã‚Œ</button>
            <button data-value="normal">æ™®é€š</button>
            <button data-value="good">è‰¯ã„</button>
          </div>
          <button id="detail-skin-btn" class="text-xs p-1 ml-1 rounded-full bg-gray-200 w-6 h-6">+</button>
        </div>
        <div class="chip-group"><label>ãƒ¡ã‚¤ã‚¯:</label>
          <div class="chips" data-group="makeup"><button data-value="yes">ã‚ã‚Š</button><button data-value="no">ãªã—</button></div>
        </div>
        <div class="chip-group"><label>å¤–å‡º:</label>
          <div class="chips" data-group="outing"><button data-value="yes">ã‚ã‚Š</button><button data-value="no">ãªã—</button></div>
        </div>
      </div>

      <div class="flex gap-2 mb-3">
        <button id="apply-recipe-btn" class="btn-primary">ãƒ¬ã‚·ãƒ”ã‚’åæ˜ </button>
        <button id="save-as-recipe-btn" class="btn-secondary">ã“ã®ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜</button>
      </div>

      <div id="recalculating-feedback" class="text-center text-sm text-gray-500 mb-4 h-5"></div>

      <div id="suggestion-card" class="hidden card text-sm"></div>

      <div id="manual-container"></div>

      <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ç½®ãå ´ -->
      <div id="apply-recipe-modal" class="hidden fixed inset-0 bg-black/30 flex items-end sm:items-center sm:justify-center z-50">
        <div class="bg-white w-full sm:w-[520px] rounded-t-2xl sm:rounded-2xl p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">ä»Šæ—¥ã®ãƒ¬ã‚·ãƒ”ã‚’é¸ã¶</h3>
            <button id="close-apply-modal" class="text-gray-500 text-lg">âœ•</button>
          </div>
          <div class="space-y-3">
            <button id="apply-yesterday" class="w-full btn-primary">æ˜¨æ—¥ã®ãƒ¬ã‚·ãƒ”ã‚’åæ˜ </button>
            <div class="mt-2">
              <div class="flex gap-2 mb-2">
                <button id="tab-saved" class="px-3 py-1 rounded bg-gray-100 text-sm">ä¿å­˜æ¸ˆã¿</button>
                <button id="tab-history" class="px-3 py-1 rounded bg-gray-100 text-sm">å±¥æ­´</button>
              </div>
              <div id="list-saved" class="space-y-2"></div>
              <div id="list-history" class="space-y-2 hidden"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="why-modal" class="hidden fixed inset-0 bg-black/30 flex items-center justify-center z-50">
        <div class="bg-white w-[90%] sm:w-[480px] rounded-2xl p-4">
          <div id="why-text" class="text-sm"></div>
          <div class="text-right mt-3"><button id="close-why" class="btn-primary">OK</button></div>
        </div>
      </div>
    `;

    // çŠ¶æ…‹ãƒãƒƒãƒ—ã®é¸æŠåæ˜ 
    container.querySelectorAll('.chips').forEach(div => {
      div.querySelectorAll('button').forEach(btn => {
        const group = div.dataset.group;
        btn.classList.toggle('selected', btn.dataset.value === state.dailyConditions[group]);
      });
      div.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;
        state.dailyConditions[div.dataset.group] = e.target.dataset.value;
        if (state.today) state.today.conditions = { ...state.dailyConditions };
        saveState();
        showRecalc(() => {
          // ãƒ«ãƒ¼ãƒ«å†é©ç”¨
          recalcTodayByRules();
          renderManual();
        });
        // UIæ›´æ–°
        div.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
        e.target.classList.add('selected');
      });
    });

    // ãƒ¬ã‚·ãƒ”åæ˜ ãƒ¢ãƒ¼ãƒ€ãƒ«
    container.querySelector('#apply-recipe-btn').addEventListener('click', openApplyModal);
    container.querySelector('#save-as-recipe-btn').addEventListener('click', onSaveCurrentAsRecipe);

    // åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    if (!state.today || !state.today.am.length && !state.today.pm.length) {
      // å½“æ—¥ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ç”Ÿæˆï¼ˆæ¡ä»¶ãƒ™ãƒ¼ã‚¹ï¼‰
      state.today = makeTodayFromRules();
      saveState();
    }
    renderManual();
    refreshSuggestionCard();
  }

  /* ========== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆæ‰‹é †ï¼‰ ========== */
  function renderManual() {
    const container = document.getElementById('manual-container');
    if (!container || !state.today) return;

    // åˆè¨ˆæ™‚é–“ç®—å‡º
    const { amMinutes, pmMinutes } = calcDurations(state.today);
    const amHTML = createRoutineSectionHTML('â˜€ï¸ æœã®ãƒ¬ã‚·ãƒ”', state.today.am, amMinutes, 'AM');
    const pmHTML = createRoutineSectionHTML('ğŸŒ™ å¤œã®ãƒ¬ã‚·ãƒ”', state.today.pm, pmMinutes, 'PM');
    container.innerHTML = amHTML + pmHTML;

    // è¿½åŠ /å¤–ã™/whyã‚¤ãƒ™ãƒ³ãƒˆ
    container.querySelectorAll('[data-action="add-step"]').forEach(b => {
      b.addEventListener('click', () => onAddStep(b.dataset.time));
    });
    container.querySelectorAll('[data-action="remove-today"]').forEach(b => {
      b.addEventListener('click', () => onRemoveToday(b.dataset.time, b.dataset.id));
    });
    container.querySelectorAll('[data-action="why"]').forEach(b => {
      b.addEventListener('click', () => openWhy(b.dataset.id));
    });
  }

  function createRoutineSectionHTML(title, steps, minutes, timeOfDay) {
    // éè¡¨ç¤º(hidden)ã¯æç”»ã—ãªã„
    const visibleSteps = steps.filter(s => !s.hidden);
    const listHTML = visibleSteps.map(s => taskRowHTML(s, timeOfDay)).join('');
    return `
      <div class="card p-5 mb-4">
        <div class="flex items-center justify-between">
          <h3 class="font-bold text-lg">${title}</h3>
          <span class="text-xs text-gray-500">æœ¬æ—¥ã®ç›®å®‰ï¼š${minutes}åˆ†</span>
        </div>
        <ul class="mt-3 space-y-2">${listHTML || `<li class="text-sm text-gray-400">ä»Šæ—¥ã¯è¡¨ç¤ºã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“</li>`}</ul>
        <div class="mt-4">
          <button class="btn-secondary w-full text-sm" data-action="add-step" data-time="${timeOfDay}">ï¼‹ ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ </button>
        </div>
      </div>
    `;
  }

  function taskRowHTML(step, timeOfDay) {
    const p = masterInventory.find(i => i.id === step.productId);
    const name = p ? p.name : step.stepType;
    const cate = p ? p.category : step.stepType;
    const img = p?.image || 'https://placehold.co/100x100/cccccc/FFFFFF?text=..';
    const startDate = state.products.find(x => x.id === p?.id)?.startDate;
    const daysSince = startDate ? daysBetween(new Date(startDate), new Date()) : null;
    const tip = daysSince != null ? `é–‹å§‹ã‹ã‚‰${daysSince}æ—¥` : '';
    const reason = step.why ? `<div class="reason-badge info">${step.why}</div>` : '';

    return `
      <li class="task-item">
        <input type="checkbox" class="task-checkbox" />
        <img src="${img}" alt="${name}" class="w-12 h-12 rounded-lg" />
        <div class="flex-grow ml-4">
          <p class="font-bold text-sm">
            <span class="step-name">${name}</span>
            ${tip ? `<span class="ml-2 text-[10px] text-gray-500 border rounded px-1">${tip}</span>` : ''}
          </p>
          <p class="text-xs text-gray-500">${cate}</p>
          ${reason}
        </div>
        <div class="flex gap-2">
          <button class="text-xs px-2 py-1 border rounded" data-action="why" data-id="${step.id}">i</button>
          <button class="text-xs px-2 py-1 border rounded" data-action="remove-today" data-time="${timeOfDay}" data-id="${step.id}">ä»Šæ—¥ã ã‘å¤–ã™</button>
        </div>
      </li>
    `;
  }

  /* ========== ãƒ«ãƒ¼ãƒ«é©ç”¨ï¼ˆå½“ãŸã‚Šå‰ãƒ«ãƒ¼ãƒ«ï¼‰ ========== */
  function makeTodayFromRules() {
    const date = isoDate(new Date());
    // ãƒ™ãƒ¼ã‚¹ï¼ˆAM/PMï¼‰: æ—¢å­˜ã® getRoutineItemsFor ã®ä¸­èº«ã‚’ã€ã‚¹ãƒ†ãƒƒãƒ—é…åˆ—ã§ä½œã‚‹
    const baseAM = [
      asStep('æ´—é¡”', 'item2', 'AM'),
      asStep('åŒ–ç²§æ°´', 'item4', 'AM'),
      asStep('ä¹³æ¶²', 'item6', 'AM'),
      // æ—¥ç„¼ã‘æ­¢ã‚ã¯æ¡ä»¶ã§å¾Œä»˜ã‘
    ];
    const basePM = [
      // ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°ã¯æ¡ä»¶ã§å…ˆé ­ã«
      maybeAsStep('é…µç´ æ´—é¡”', 'item3', 'PM'), // æ¡ä»¶ã§éš ã™
      asStep('æ´—é¡”', 'item2', 'PM'),
      asStep('åŒ–ç²§æ°´', 'item4', 'PM'),
      // è‚Œè’ã‚Œæ™‚ã¯ç¾å®¹æ¶²ã‚’è¶³ã™
      asStep('ä¹³æ¶²', 'item6', 'PM'),
    ];

    /** @type {DayInstance} */
    const today = {
      date, conditions: { ...state.dailyConditions },
      am: baseAM, pm: basePM,
      overrides: { amRemove: [], pmRemove: [], amAdd: [], pmAdd: [] },
      whyMap: {}
    };
    applyRulesInPlace(today);
    return today;
  }

  function recalcTodayByRules() {
    if (!state.today) return;
    // ãƒ™ãƒ¼ã‚¹ã«æˆ»ã™ã®ã§ã¯ãªãã€ã€Œç¾åœ¨ã® today ã«å¯¾ã—ã¦ hidden/why ã®å†è¨ˆç®—ã€ã‚’è¡Œã†
    applyRulesInPlace(state.today);
    saveState();
    refreshSuggestionCard();
  }

  function applyRulesInPlace(day) {
    // 1) åˆæœŸåŒ–ï¼šhidden/why ã‚¯ãƒªã‚¢
    [...day.am, ...day.pm].forEach(s => { s.hidden = false; if (!day.whyMap[s.id]) s.why = undefined; });

    const cond = day.conditions;
    const productsHave = (category) => state.products.some(p => {
      const m = masterInventory.find(mi => mi.id === p.id);
      return m && m.category === category;
    });

    // 2) ãƒ«ãƒ¼ãƒ«ï¼šå¤–å‡ºâ†’AMã«æ—¥ç„¼ã‘æ­¢ã‚å¿…é ˆ
    if (cond.outing === 'yes') {
      const hasSPF = day.am.some(s => masterInventory.find(mi => mi.id === s.productId)?.category === 'æ—¥ç„¼ã‘æ­¢ã‚' && !s.hidden);
      if (!hasSPF) {
        // ãƒã‚¤è£½å“ã«æ—¥ç„¼ã‘æ­¢ã‚ãŒã‚ã‚Œã°è¿½åŠ ã€ãªã‘ã‚Œã°ä¸è¶³ææ¡ˆã¸
        const ownedSPF = state.products.map(x => x.id).map(id => masterInventory.find(m => m.id === id))
          .find(m => m?.category === 'æ—¥ç„¼ã‘æ­¢ã‚');
        if (ownedSPF) {
          day.am.push(asStep('æ—¥ç„¼ã‘æ­¢ã‚', ownedSPF.id, 'AM', 'å¤–å‡ºã®ãŸã‚è¿½åŠ ã—ã¾ã—ãŸ'));
        } // ãªã‘ã‚Œã° suggestionCard å´ã§æ¤œçŸ¥
      }
    }

    // 3) ãƒ«ãƒ¼ãƒ«ï¼šãƒ¡ã‚¤ã‚¯â†’PMå…ˆé ­ã«ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°å¿…é ˆ
    if (cond.makeup === 'yes') {
      const hasCleanse = day.pm.some(s => masterInventory.find(mi => mi.id === s.productId)?.category === 'ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°' && !s.hidden);
      if (!hasCleanse) {
        const ownedCLR = state.products.map(x => x.id).map(id => masterInventory.find(m => m.id === id))
          .find(m => m?.category === 'ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°');
        if (ownedCLR) {
          day.pm.unshift(asStep('ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°', ownedCLR.id, 'PM', 'ãƒ¡ã‚¤ã‚¯ã—ã¦ã„ã‚‹ãŸã‚è¿½åŠ ã—ã¾ã—ãŸ'));
        }
      }
    }

    // 4) ãƒ«ãƒ¼ãƒ«ï¼šè‚Œè’ã‚Œâ†’é…µç´ /å¼·ã‚ã¯éš ã™ã€é®é™ç³»ã¯whyã‚’ä»˜ã‘ã‚‹
    if (cond.skin === 'bad') {
      const hideTags = ['enzyme', 'acid', 'retinoid'];
      [...day.am, ...day.pm].forEach(s => {
        const prod = masterInventory.find(mi => mi.id === s.productId);
        if (!prod) return;
        const tags = prod.tags || [];
        if (tags.some(t => hideTags.includes(t)) || prod.category === 'é…µç´ æ´—é¡”') {
          s.hidden = true;
          s.why = 'è‚ŒãŒè’ã‚Œã¦ã„ã‚‹ãŸã‚å¤–ã—ã¦ã„ã¾ã™';
        }
        if (prod.category === 'ç¾å®¹æ¶²') {
          s.why = s.why || 'è‚Œè’ã‚Œã‚±ã‚¢ã®ãŸã‚è¡¨ç¤ºã—ã¦ã„ã¾ã™';
        }
      });
    }

    // 5) overridesï¼ˆå½“æ—¥ã ã‘ã®å¢—æ¸›ï¼‰ã‚’åæ˜ 
    day.am.forEach(s => { if (day.overrides.amRemove.includes(s.id)) s.hidden = true; });
    day.pm.forEach(s => { if (day.overrides.pmRemove.includes(s.id)) s.hidden = true; });

    // 6) ä¸è¶³ã‚«ãƒ†ã‚´ãƒªã®æ¤œçŸ¥ã¯ UI å´ã§è¡Œã†
  }

  /* ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šã‚¹ãƒ†ãƒƒãƒ—ç”Ÿæˆãƒ»æ‰€è¦æ™‚é–“ç®—å‡º ========== */
  function uuid() { return Math.random().toString(36).slice(2, 10); }
  function asStep(stepType, productId, tod, why) {
    const prod = masterInventory.find(i => i.id === productId);
    return {
      id: uuid(), timeOfDay: tod, order: 0, stepType,
      productId, durationMin: DURATION_MIN[prod?.category || stepType] || 1, hidden: false, why
    };
  }
  function maybeAsStep(stepType, productId, tod) {
    const prod = masterInventory.find(i => i.id === productId);
    if (!prod) return null;
    return asStep(stepType, productId, tod);
  }

  function calcDurations(day) {
    const sum = (arr) => arr.filter(s => !s.hidden).reduce((acc, s) => acc + (s.durationMin || 1), 0);
    return { amMinutes: sum(day.am), pmMinutes: sum(day.pm) };
  }

  /* ========== å½“æ—¥ã ã‘ã®å¢—æ¸› ========== */
  function onRemoveToday(tod, stepId) {
    if (!state.today) return;
    const key = tod === 'AM' ? 'amRemove' : 'pmRemove';
    if (!state.today.overrides[key].includes(stepId)) state.today.overrides[key].push(stepId);
    saveState();
    renderManual();
  }

  function onAddStep(tod) {
    // ã‚·ãƒ³ãƒ—ãƒ«ãªè¿½åŠ UIï¼šã‚«ãƒ†ã‚´ãƒªã‚’é¸ã³ã€æ‰€æœ‰è£½å“ã‹ã‚‰é¸ã¶
    const category = prompt(`è¿½åŠ ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šç¾å®¹æ¶², ä¹³æ¶², æ—¥ç„¼ã‘æ­¢ã‚, æ´—é¡”, ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°, é…µç´ æ´—é¡”, åŒ–ç²§æ°´ï¼‰`);
    if (!category) return;
    const owned = state.products
      .map(x => masterInventory.find(m => m.id === x.id))
      .filter(Boolean)
      .filter(m => m.category === category.trim());
    if (!owned.length) {
      alert(`ã€Œ${category}ã€ã®ç™»éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚³ã‚¹ãƒ¡ä¸€è¦§ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚`);
      return;
    }
    const names = owned.map((m, i) => `${i + 1}: ${m.name}`).join('\n');
    const pick = prompt(`è¿½åŠ ã™ã‚‹è£½å“ã‚’é¸ã‚“ã§ãã ã•ã„ï¼š\n${names}`);
    const idx = Number(pick) - 1;
    if (isNaN(idx) || idx < 0 || idx >= owned.length) return;
    const chosen = owned[idx];
    const step = asStep(chosen.category, chosen.id, tod, 'æ‰‹å‹•ã§è¿½åŠ ã—ã¾ã—ãŸ');
    if (tod === 'AM') state.today.am.push(step); else state.today.pm.push(step);
    saveState();
    renderManual();
  }

  /* ========== ãƒ¬ã‚·ãƒ”ä¿å­˜ãƒ»åæ˜ ï¼ˆæ˜¨æ—¥ï¼ä¿å­˜æ¸ˆã¿ï¼å±¥æ­´ï¼‰ ========== */
  function openApplyModal() {
    const modal = document.getElementById('apply-recipe-modal');
    modal.classList.remove('hidden');
    document.getElementById('close-apply-modal').onclick = () => modal.classList.add('hidden');

    // æ˜¨æ—¥ã®åæ˜ 
    const btnYesterday = document.getElementById('apply-yesterday');
    const yesterday = state.history[0]; // æœ€æ–°ã®å±¥æ­´ï¼æ˜¨æ—¥æƒ³å®š
    btnYesterday.disabled = !yesterday;
    btnYesterday.classList.toggle('opacity-50', !yesterday);
    btnYesterday.onclick = () => {
      if (!yesterday) return;
      state.today = dayFromRecipe(yesterday);
      state.today.date = isoDate(new Date());
      saveState();
      modal.classList.add('hidden');
      renderManual();
      refreshSuggestionCard();
    };

    // ã‚¿ãƒ–åˆ‡æ›¿
    const tabSaved = document.getElementById('tab-saved');
    const tabHistory = document.getElementById('tab-history');
    const listSaved = document.getElementById('list-saved');
    const listHistory = document.getElementById('list-history');

    function renderSaved() {
      listSaved.innerHTML = (state.savedRecipes || []).map(r => recipeRow(r, () => {
        state.today = dayFromRecipe(r);
        state.today.date = isoDate(new Date());
        saveState();
        modal.classList.add('hidden');
        renderManual();
        refreshSuggestionCard();
      })).join('') || `<p class="text-sm text-gray-500">ä¿å­˜æ¸ˆã¿ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“</p>`;
    }
    function renderHistory() {
      const items = (state.history || []).slice(0, 10);
      listHistory.innerHTML = items.map(r => recipeRow(r, () => {
        state.today = dayFromRecipe(r);
        state.today.date = isoDate(new Date());
        saveState();
        modal.classList.add('hidden');
        renderManual();
        refreshSuggestionCard();
      })).join('') || `<p class="text-sm text-gray-500">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>`;
    }
    function activate(tab) {
      if (tab === 'saved') {
        listSaved.classList.remove('hidden'); listHistory.classList.add('hidden');
      } else {
        listSaved.classList.add('hidden'); listHistory.classList.remove('hidden');
      }
    }

    tabSaved.onclick = () => { activate('saved'); };
    tabHistory.onclick = () => { activate('history'); };

    renderSaved();
    renderHistory();
    activate('saved');
  }

  function recipeRow(r, onApply) {
    const when = (r.createdAt || '').slice(0, 10);
    const name = r.name || 'ç„¡é¡Œãƒ¬ã‚·ãƒ”';
    const steps = (r.am?.filter(s=>!s.hidden).length || 0) + (r.pm?.filter(s=>!s.hidden).length || 0);
    return `
      <div class="flex items-center justify-between border rounded p-2">
        <div>
          <div class="text-sm font-medium">${name}</div>
          <div class="text-xs text-gray-500">${when} / ${steps}ã‚¹ãƒ†ãƒƒãƒ—</div>
        </div>
        <button class="btn-secondary text-xs" onclick="(${onApply.toString()})()">åæ˜ </button>
      </div>
    `;
  }

  function onSaveCurrentAsRecipe() {
    if (!state.today) return;
    const name = prompt('ã“ã®ãƒ¬ã‚·ãƒ”ã«åå‰ã‚’ã¤ã‘ã¦ä¿å­˜ï¼ˆä¾‹ï¼šè‚Œè’ã‚Œç”¨PMï¼‰');
    const recipe = {
      id: uuid(),
      name: name || undefined,
      createdAt: new Date().toISOString(),
      am: deepClone(state.today.am),
      pm: deepClone(state.today.pm)
    };
    state.savedRecipes.unshift(recipe);
    saveState();
    alert('ä¿å­˜ã—ã¾ã—ãŸ');
  }

  function dayFromRecipe(r) {
    return {
      date: isoDate(new Date()),
      conditions: { ...state.dailyConditions },
      am: deepClone(r.am), pm: deepClone(r.pm),
      overrides: { amRemove: [], pmRemove: [], amAdd: [], pmAdd: [] },
      whyMap: {}
    };
  }

  /* ========== ä¸è¶³ã‚«ãƒ†ã‚´ãƒªã®ææ¡ˆï¼ˆå¿…è¦æ™‚ã®ã¿ï¼‰ ========== */
  function refreshSuggestionCard() {
    const card = document.getElementById('suggestion-card');
    if (!card || !state.today) return;
    card.classList.add('hidden');
    // å¿…é ˆãƒ­ã‚¸ãƒƒã‚¯ï¼šå¤–å‡ºâ†’æ—¥ç„¼ã‘æ­¢ã‚ã€ãƒ¡ã‚¤ã‚¯â†’ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°
    const need = [];
    if (state.today.conditions.outing === 'yes') {
      const hasSPF = state.today.am.some(s => !s.hidden && masterInventory.find(m=>m.id===s.productId)?.category==='æ—¥ç„¼ã‘æ­¢ã‚');
      if (!hasSPF) need.push('æ—¥ç„¼ã‘æ­¢ã‚');
    }
    if (state.today.conditions.makeup === 'yes') {
      const hasCLR = state.today.pm.some(s => !s.hidden && masterInventory.find(m=>m.id===s.productId)?.category==='ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°');
      if (!hasCLR) need.push('ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°');
    }
    // æ‰€æœ‰ãƒã‚§ãƒƒã‚¯
    const lacks = need.filter(cat => !state.products.some(p => masterInventory.find(m => m.id===p.id)?.category===cat));
    if (!lacks.length) return;
    const cats = [...new Set(lacks)].join('ãƒ»');
    card.innerHTML = `
      <div class="flex items-center justify-between">
        <div><strong>${cats}</strong> ãŒæœªç™»éŒ²ã§ã™ã€‚è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ</div>
        <button class="btn-primary text-xs" id="add-missing">è¿½åŠ </button>
      </div>
    `;
    card.classList.remove('hidden');
    document.getElementById('add-missing').onclick = () => {
      // ç°¡æ˜“ï¼šæ‰€æœ‰ã«è¿½åŠ ï¼ˆå®Ÿéš›ã¯æ¤œç´¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ç¹‹ãï¼‰
      const options = masterInventory
        .filter(m => lacks.includes(m.category))
        .map((m,i)=>`${i+1}: ${m.category} / ${m.name}`).join('\n');
      const pick = prompt(`è¿½åŠ ã™ã‚‹è£½å“ã‚’é¸ã‚“ã§ãã ã•ã„ï¼š\n${options}`);
      const idx = Number(pick)-1;
      const pool = masterInventory.filter(m => lacks.includes(m.category));
      if (!isNaN(idx) && pool[idx]) {
        if (!state.products.some(p => p.id===pool[idx].id)) state.products.push({ id: pool[idx].id });
        saveState();
        recalcTodayByRules();
        renderManual();
      }
    };
  }

  /* ========== WHY è¡¨ç¤º ========== */
  function openWhy(stepId) {
    const modal = document.getElementById('why-modal');
    const step = [...(state.today?.am||[]), ...(state.today?.pm||[])].find(s => s.id === stepId);
    const text = step?.why || 'ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ç†ç”±ã¯ç‰¹ã«ã‚ã‚Šã¾ã›ã‚“ã€‚';
    document.getElementById('why-text').textContent = text;
    modal.classList.remove('hidden');
    document.getElementById('close-why').onclick = () => modal.classList.add('hidden');
  }

  /* ========== æ—¥ä»˜è·¨ãï¼ˆtodayâ†’historyï¼‰ ========== */
  function rolloverIfNeeded() {
    const todayISO = isoDate(new Date());
    if (!state.today || state.today.date === todayISO) return;
    // æ˜¨æ—¥ã®ç¢ºå®šãƒ¬ã‚·ãƒ”ã¨ã—ã¦å±¥æ­´ã¸ä¿å­˜
    state.history.unshift({
      id: uuid(), createdAt: state.today.date + 'T00:00:00Z',
      am: deepClone(state.today.am), pm: deepClone(state.today.pm)
    });
    // æ–°ã—ã„ today ã‚’ä½œæˆ
    state.today = makeTodayFromRules();
    saveState();
  }

  /* ========== è£œåŠ©UIï¼ˆä»–ç”»é¢ã¯ç¾çŠ¶ã®ç°¡æ˜“ç‰ˆï¼‰ ========== */
  function renderScheduleScreen(container) {
    container.innerHTML = `
      <div class="card"><h2>ç°¡æ˜“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h2>
      <p class="text-sm text-gray-500">é–‹ç™ºä¸­ã§ã™</p></div>
    `;
  }

  function renderInventoryScreen(container) {
    const itemsHTML = masterInventory.map(item => {
      const prodState = state.products.find(p => p.id===item.id);
      const start = prodState?.startDate || '';
      return `
        <div class="border rounded p-3">
          <img src="${item.image}" class="w-24 h-24 rounded-lg mx-auto mb-2" />
          <p class="font-bold text-sm text-center">${item.name}</p>
          <p class="text-xs text-gray-500 text-center">${item.category}</p>
          <div class="mt-2 text-xs">
            <label class="block">é–‹å§‹æ—¥ï¼ˆä»»æ„ï¼‰
              <input type="date" value="${start}" data-pid="${item.id}" class="mt-1 w-full border rounded px-2 py-1 text-sm"/>
            </label>
          </div>
        </div>
      `;
    }).join('');
    container.innerHTML = `
      <div class="card"><h2>ãƒã‚¤ã‚³ã‚¹ãƒ¡</h2>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mt-3">${itemsHTML}</div>
      </div>
    `;
    container.querySelectorAll('input[type="date"]').forEach(inp => {
      inp.addEventListener('change', () => {
        const pid = inp.dataset.pid;
        const rec = state.products.find(p => p.id===pid);
        if (rec) rec.startDate = inp.value || undefined;
        saveState();
      });
    });
  }

  function renderDiaryScreen(container) {
    const list = (state.history || []).slice(0, 10);
    const html = list.map(r => {
      const steps = (r.am?.filter(s=>!s.hidden).length||0) + (r.pm?.filter(s=>!s.hidden).length||0);
      return `<div class="border rounded p-3 mb-3">
        <div class="text-sm font-semibold">${(r.createdAt||'').slice(0,10)}</div>
        <div class="text-xs text-gray-500">${steps} ã‚¹ãƒ†ãƒƒãƒ—</div>
      </div>`;
    }).join('') || `<p class="text-sm text-gray-500">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>`;
    container.innerHTML = `<div class="card"><h2>ãƒ€ã‚¤ã‚¢ãƒªãƒ¼</h2>${html}</div>`;
  }

  function renderAccountScreen(container) {
    container.innerHTML = `<div class="card"><h2>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</h2><p>ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ä¸è¦ã§ä½¿ãˆã¾ã™ã€‚</p></div>`;
  }

  /* ========== å…±é€šãƒ˜ãƒ«ãƒ‘ãƒ¼ ========== */
  function displayDate() {
    const today = new Date();
    const text = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
    document.getElementById('current-date').textContent = text;
  }
  function isoDate(d) { return d.toISOString().slice(0, 10); }
  function daysBetween(a, b) { return Math.floor((+b - +a) / (1000*60*60*24)); }
  function deepClone(x){ return JSON.parse(JSON.stringify(x)); }
  function showRecalc(cb){ const el = document.getElementById('recalculating-feedback'); if(!el){cb();return;} el.textContent='ãƒ¬ã‚·ãƒ”ã‚’å†è¨ˆç®—ä¸­...'; setTimeout(()=>{ el.textContent=''; cb(); },200); }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼ˆrecipeRowã®ç°¡æ˜“onclickç”¨ï¼‰
  window.state = state;
});
</script>

</body>
</html>


